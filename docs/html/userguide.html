

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>User Guide &#8212; partialwrap</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=ac02cc09edc035673794" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/css/custom.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=ac02cc09edc035673794" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=ac02cc09edc035673794"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'userguide';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Public API" href="api.html" />
    <link rel="prev" title="Quickstart" href="index.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="contents.html">
  
  
  
  
  
    <p class="title logo__title">partialwrap</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="index.html">Quickstart</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">User Guide</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="api.html">Public API</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="wrappers.html">partialwrap.wrappers</a></li>
<li class="toctree-l2"><a class="reference internal" href="std_io.html">partialwrap.std_io</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">Authors</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/mcuntz/partialwrap" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/mcuntz/partialwrap/edit/main/docs/userguide.rst" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/mcuntz/partialwrap/issues/new?title=Issue%20on%20page%20%2Fuserguide.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/userguide.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>User Guide</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#external-executables">External executables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#masked-parameters">Masked parameters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-arguments">Additional arguments</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parallel-evaluation">Parallel evaluation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-launch-scripts">Using launch scripts</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#input-output-functions">Input/Output functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#python-functions">Python functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-real-life-example">A real life example</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="user-guide">
<h1>User Guide<a class="headerlink" href="#user-guide" title="Permalink to this heading">#</a></h1>
<p>Partial’s ingenious mechanism allows to use even very complex
functions with many arguments and keyword arguments with routines that
need functions in the simple form <cite>func(x)</cite>. This includes Python’s
<a class="reference external" href="https://docs.python.org/3/library/functions.html#map" title="(in Python v3.12)"><code class="xref py py-func docutils literal notranslate"><span class="pre">map()</span></code></a> function, the minimizers in <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/optimize.html#module-scipy.optimize" title="(in SciPy v1.11.4)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">scipy.optimize</span></code></a>, and
plenty of third-party modules such as <a class="reference external" href="https://emcee.readthedocs.io/en/latest/">emcee</a> or <a class="reference external" href="https://pyeee.readthedocs.io/en/latest/package.html#module-pyeee" title="(in pyeee v3.0)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyeee</span></code></a>. It
also allows easy parallelization of code with, for example, the
parallel <cite>map</cite> function of the <a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html#module-multiprocessing" title="(in Python v3.12)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">multiprocessing</span></code></a> module or via
the Message Passing Interface (MPI) <a class="reference external" href="https://mpi4py.readthedocs.io/en/latest/mpi4py.html#module-mpi4py" title="(in MPI for Python v4.0.0)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mpi4py</span></code></a>.</p>
<p><code class="docutils literal notranslate"><span class="pre">partialwrap</span></code> provides two easy wrappers so that
<a class="reference external" href="https://docs.python.org/3/library/functools.html#functools.partial" title="(in Python v3.12)"><code class="xref py py-func docutils literal notranslate"><span class="pre">functools.partial()</span></code></a> can be used with external programs as well
as Python functions. It provides further convenience functions to deal
with input/output of external programs. The user guide gives examples
how to use pretty much every external executable with any Python
program.</p>
<section id="external-executables">
<h2>External executables<a class="headerlink" href="#external-executables" title="Permalink to this heading">#</a></h2>
<p>The great power of <code class="docutils literal notranslate"><span class="pre">partialwrap</span></code> is its ability to wrap external
executables that cannot directly be called from Python via <a class="reference external" href="https://cython.readthedocs.io/">Cython</a>,
<a class="reference external" href="https://numpy.org/doc/stable/f2py/usage.html#module-numpy.f2py" title="(in NumPy v1.26)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">numpy.f2py</span></code></a> or similar.</p>
<p><code class="docutils literal notranslate"><span class="pre">partialwrap</span></code> provides two wrapper functions to work with external
executables: <a class="reference internal" href="wrappers.html#partialwrap.wrappers.exe_wrapper" title="partialwrap.wrappers.exe_wrapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code></a> and
<a class="reference internal" href="wrappers.html#partialwrap.wrappers.exe_mask_wrapper" title="partialwrap.wrappers.exe_mask_wrapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">exe_mask_wrapper()</span></code></a>. The two wrappers
basically launch an external executable <cite>exe</cite> using Python’s
<a class="reference external" href="https://docs.python.org/3/library/subprocess.html#module-subprocess" title="(in Python v3.12)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">subprocess</span></code></a> module, while providing functionality to write
parameter files and read in model output. The wrappers write a
parameter set into file(s) <cite>parameterfile</cite> that are needed by the
external program <cite>exe</cite>. The external program <cite>exe</cite> should write its
result(s) to (a) file(s) <cite>outputfile</cite>, which will then be read by the
wrappers in return. This means that the two wrappers need to know a
function <cite>parameterwriter</cite> that writes the parameters in the file(s)
<cite>parameterfile</cite> suitable for the external model <cite>exe</cite>. The wrappers
also need to know a function <cite>outputreader</cite> that reads the model
output(s) from the file(s) <cite>outputfile</cite>, and possibly calculating an
objective value or just passing back the output value(s).</p>
<p>Consider the <em>Rastrigin function</em>
(<a class="reference external" href="https://en.wikipedia.org/wiki/Rastrigin_function">https://en.wikipedia.org/wiki/Rastrigin_function</a>), which is a popular
function for performance testing of optimization algorithms:
<span class="math notranslate nohighlight">\(y = a \cdot n + \sum_i^n (x_i^2 - a \cos(b \cdot x_i))\)</span>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">def</span> <span class="nf">rastrigin</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
<p>The Rastrigin function has a global minimum of <span class="math notranslate nohighlight">\(0\)</span> at all
<span class="math notranslate nohighlight">\(x_i = 0\)</span>. <span class="math notranslate nohighlight">\(a\)</span> influences mainly the depths of the (local
and global) minima, whereas <span class="math notranslate nohighlight">\(b\)</span> influences mainly the size of
the minima. A common form uses <span class="math notranslate nohighlight">\(a = 10\)</span> and <span class="math notranslate nohighlight">\(b = 2\pi\)</span>.
The parameters <span class="math notranslate nohighlight">\(x_i\)</span> should then be in the interval
<span class="math notranslate nohighlight">\([-5.12, 5.12]\)</span>.</p>
<p>Take an external program that calculates the Rastrigin function with
<span class="math notranslate nohighlight">\(a = 10\)</span> and <span class="math notranslate nohighlight">\(b = 2 \pi\)</span>, reading in an arbitrary number
of parameters <span class="math notranslate nohighlight">\(x_i\)</span> from a <cite>parameterfile = params.txt</cite> and
writing its output into an <cite>outputfile = out.txt</cite>. Take for simplicity
a Python program first (e.g. <cite>rastrigin.py</cite>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File: rastrigin.py</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">standard_parameter_reader</span>

<span class="c1"># Rastrigin function a=10, b=2*pi</span>
<span class="k">def</span> <span class="nf">rastrigin</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">10.</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">10.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span><span class="p">))</span>

<span class="c1"># read parameters</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">standard_parameter_reader</span><span class="p">(</span><span class="s1">&#39;params.txt&#39;</span><span class="p">)</span>

<span class="c1"># calc function</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">rastrigin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># write output file</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;out.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">ff</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="std_io.html#partialwrap.std_io.standard_parameter_reader" title="partialwrap.std_io.standard_parameter_reader"><code class="xref py py-func docutils literal notranslate"><span class="pre">standard_parameter_reader()</span></code></a> is a convenience
functions that reads parameters from a file, one per line returning a
<a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.26)"><code class="xref py py-class docutils literal notranslate"><span class="pre">numpy.ndarray</span></code></a>. The external program, which is in full
<cite>python3 rastrigin.py</cite>, can be used with the wrapper function
<a class="reference internal" href="wrappers.html#partialwrap.wrappers.exe_wrapper" title="partialwrap.wrappers.exe_wrapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code></a> of <code class="docutils literal notranslate"><span class="pre">partialwrap</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">opt</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">exe_wrapper</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">standard_parameter_writer</span><span class="p">,</span> <span class="n">standard_output_reader</span>

<span class="n">rastrigin_exe</span>   <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span> <span class="s1">&#39;rastrigin.py&#39;</span><span class="p">]</span>
<span class="n">parameterfile</span>   <span class="o">=</span> <span class="s1">&#39;params.txt&#39;</span>
<span class="n">parameterwriter</span> <span class="o">=</span> <span class="n">standard_parameter_writer</span>
<span class="n">outputfile</span>      <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span>
<span class="n">outputreader</span>    <span class="o">=</span> <span class="n">standard_output_reader</span>
<span class="n">rastrigin_wrap</span>  <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">rastrigin_exe</span><span class="p">,</span>
                          <span class="n">parameterfile</span><span class="p">,</span> <span class="n">parameterwriter</span><span class="p">,</span>
                          <span class="n">outputfile</span><span class="p">,</span> <span class="n">outputreader</span><span class="p">,</span> <span class="p">{})</span>
<span class="n">x0</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">rastrigin_wrap</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;BFGS&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="std_io.html#partialwrap.std_io.standard_parameter_writer" title="partialwrap.std_io.standard_parameter_writer"><code class="xref py py-func docutils literal notranslate"><span class="pre">standard_parameter_writer()</span></code></a> is another
convenience function that writes parameters into a file, one per
line. The function <a class="reference internal" href="std_io.html#partialwrap.std_io.standard_output_reader" title="partialwrap.std_io.standard_output_reader"><code class="xref py py-func docutils literal notranslate"><span class="pre">standard_output_reader()</span></code></a>
simply reads one value from a file. The empty dictionary at the end of
the partial statement is explained below.</p>
<p>One can see that the external Rastrigin program could have been
written in a compiled language such as C, Fortran or similar, and then
used with the <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/optimize.html#module-scipy.optimize" title="(in SciPy v1.11.4)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">scipy.optimize</span></code></a> algorithms in Python. A Fortran
program could look like this:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">program </span><span class="n">rastrigin</span>

<span class="w">    </span><span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">kind</span><span class="p">(</span><span class="mf">1.0d0</span><span class="p">)</span>

<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">pi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.141592653589793238462643383279502884197_dp</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="mf">0.0_dp</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0_dp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pi</span>

<span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">pfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;params.txt&#39;</span>
<span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ofile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;out.txt&#39;</span>

<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">punit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ounit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">101</span>

<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="c">! parameters, up to 100 dimensions</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">out</span><span class="w">               </span><span class="c">! output value</span>
<span class="w">    </span><span class="kt">integer</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span><span class="w">                 </span><span class="c">! number of dimensions</span>

<span class="w">    </span><span class="kt">integer</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">ios</span>

<span class="w">    </span><span class="c">! read parameters</span>
<span class="w">    </span><span class="k">open</span><span class="p">(</span><span class="n">punit</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="n">pfile</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;old&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;read&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="n">ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">n</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">do while</span><span class="w"> </span><span class="p">(</span><span class="n">ios</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">read</span><span class="p">(</span><span class="n">punit</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">=*</span><span class="p">,</span><span class="w"> </span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="w">        </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">end do</span>
<span class="k">    </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="k">close</span><span class="p">(</span><span class="n">punit</span><span class="p">)</span>

<span class="w">    </span><span class="c">! calc function</span>
<span class="w">    </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kt">real</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">dp</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">cos</span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="p">)))</span>

<span class="w">    </span><span class="c">! write output file</span>
<span class="w">    </span><span class="k">open</span><span class="p">(</span><span class="n">ounit</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="n">ofile</span><span class="p">)</span>
<span class="w">    </span><span class="k">write</span><span class="p">(</span><span class="n">ounit</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">out</span>
<span class="w">    </span><span class="k">close</span><span class="p">(</span><span class="n">ounit</span><span class="p">)</span>

<span class="k">end program </span><span class="n">rastrigin</span>
</pre></div>
</div>
<p>This program can be compiled like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gfortran<span class="w"> </span>-o<span class="w"> </span>rastrigin.exe<span class="w"> </span>rastrigin.f90
</pre></div>
</div>
<p>and used in Python:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">opt</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">exe_wrapper</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">standard_parameter_writer</span><span class="p">,</span> <span class="n">standard_output_reader</span>

<span class="n">rastrigin_exe</span>   <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;./rastrigin.exe&#39;</span><span class="p">]</span>
<span class="n">parameterfile</span>   <span class="o">=</span> <span class="s1">&#39;params.txt&#39;</span>
<span class="n">parameterwriter</span> <span class="o">=</span> <span class="n">standard_parameter_writer</span>
<span class="n">outputfile</span>      <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span>
<span class="n">outputreader</span>    <span class="o">=</span> <span class="n">standard_output_reader</span>
<span class="n">rastrigin_wrap</span>  <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">rastrigin_exe</span><span class="p">,</span>
                          <span class="n">parameterfile</span><span class="p">,</span> <span class="n">parameterwriter</span><span class="p">,</span>
                          <span class="n">outputfile</span><span class="p">,</span> <span class="n">outputreader</span><span class="p">,</span> <span class="p">{})</span>
<span class="n">x0</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">rastrigin_wrap</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;BFGS&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Where the only difference to the Python version is that
<cite>rastrigin_exe = [‘./rastrigin.exe’]</cite> instead of
<cite>rastrigin_exe = [‘python3’, ‘rastrigin.py’]</cite>.</p>
<p>The wrapper function <a class="reference internal" href="wrappers.html#partialwrap.wrappers.exe_wrapper" title="partialwrap.wrappers.exe_wrapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code></a> adds
about 50 ms of overhead per function evaluation. Compare this to 5 ms
of the compiled Fortran program when run in a <a class="reference external" href="https://docs.python.org/3/library/subprocess.html#module-subprocess" title="(in Python v3.12)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">subprocess</span></code></a> and
180 ms for the Python version. Real-life executables normally have
much longer run times so that the overhead is negligible.</p>
</section>
<section id="masked-parameters">
<h2>Masked parameters<a class="headerlink" href="#masked-parameters" title="Permalink to this heading">#</a></h2>
<p>A common case in numerical optimization is the exclusion of some
well-known or screened parameters from optimization, or fixing
correlated parameters during optimization. But the numerical model
still needs to get a parameter value for the excluded/fixed parameters
during optimization. <code class="docutils literal notranslate"><span class="pre">partialwrap</span></code> provides the wrapper function
<a class="reference internal" href="wrappers.html#partialwrap.wrappers.exe_mask_wrapper" title="partialwrap.wrappers.exe_mask_wrapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">exe_mask_wrapper()</span></code></a> to include only the
masked parameters in the function evaluation and take default values
<cite>x0</cite> where <cite>mask==False</cite>. Fixing the second parameter to a default
value of 0.0001 changes the above program to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">opt</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">exe_mask_wrapper</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">standard_parameter_writer</span><span class="p">,</span> <span class="n">standard_output_reader</span>

<span class="n">rastrigin_exe</span>   <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;./rastrigin.exe&#39;</span><span class="p">]</span>
<span class="n">parameterfile</span>   <span class="o">=</span> <span class="s1">&#39;params.txt&#39;</span>
<span class="n">parameterwriter</span> <span class="o">=</span> <span class="n">standard_parameter_writer</span>
<span class="n">outputfile</span>      <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span>
<span class="n">outputreader</span>    <span class="o">=</span> <span class="n">standard_output_reader</span>
<span class="n">x0</span>              <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
<span class="n">mask</span>            <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
<span class="n">rastrigin_wrap</span>  <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">exe_mask_wrapper</span><span class="p">,</span> <span class="n">rastrigin_exe</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span>
                          <span class="n">parameterfile</span><span class="p">,</span> <span class="n">parameterwriter</span><span class="p">,</span>
                          <span class="n">outputfile</span><span class="p">,</span> <span class="n">outputreader</span><span class="p">,</span> <span class="p">{})</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">rastrigin_wrap</span><span class="p">,</span> <span class="n">x0</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;BFGS&#39;</span><span class="p">)</span>
<span class="n">xout</span>       <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">xout</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
</pre></div>
</div>
<p>The values of <cite>x0</cite> will be taken where <cite>mask==False</cite>, i.e. <cite>mask</cite>
could be called an <em>include mask</em> in contrast to the mask of numpy’s
<a class="reference external" href="https://numpy.org/doc/stable/reference/maskedarray.html">masked arrays</a>, which is rather an <em>exclude mask</em>.</p>
<p>Note that the optimizer <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html#scipy.optimize.minimize" title="(in SciPy v1.11.4)"><code class="xref py py-func docutils literal notranslate"><span class="pre">minimize()</span></code></a> ‘sees’ only
the masked parameters so that the initial values <cite>x0</cite> and possible
<cite>bounds</cite> given to the optimizer should also be only the masked values,
here <cite>x0[mask]</cite>.</p>
<p><a class="reference internal" href="wrappers.html#partialwrap.wrappers.exe_mask_wrapper" title="partialwrap.wrappers.exe_mask_wrapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">exe_mask_wrapper()</span></code></a> basically does the
transformation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">xx</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
<span class="n">xx</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
</pre></div>
</div>
<p>and then calls <a class="reference internal" href="wrappers.html#partialwrap.wrappers.exe_wrapper" title="partialwrap.wrappers.exe_wrapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code></a> with <cite>xx</cite>
(instead of <cite>x</cite>). So everything written in the following about
<a class="reference internal" href="wrappers.html#partialwrap.wrappers.exe_wrapper" title="partialwrap.wrappers.exe_wrapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code></a> is also valid for
<a class="reference internal" href="wrappers.html#partialwrap.wrappers.exe_mask_wrapper" title="partialwrap.wrappers.exe_mask_wrapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">exe_mask_wrapper()</span></code></a>.</p>
</section>
<section id="additional-arguments">
<h2>Additional arguments<a class="headerlink" href="#additional-arguments" title="Permalink to this heading">#</a></h2>
<p>The user can pass further arguments to
<a class="reference internal" href="wrappers.html#partialwrap.wrappers.exe_wrapper" title="partialwrap.wrappers.exe_wrapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code></a> via a dictionary at the end
of the call, which was empty at the examples above.</p>
<p><strong>shell</strong> If one needs to access shell features such as pipes,
wildcards, environment variables, etc., in the call to the external
executable <cite>exe</cite>, the latter can be called in a separate shell of the
operating system. Setting the key <cite>shell</cite> to <cite>True</cite> passes
<cite>shell=True</cite> to <a class="reference external" href="https://docs.python.org/3/library/subprocess.html#subprocess.run" title="(in Python v3.12)"><code class="xref py py-func docutils literal notranslate"><span class="pre">subprocess.run()</span></code></a>. Note that the interpretation
of <cite>exe</cite> in <a class="reference external" href="https://docs.python.org/3/library/subprocess.html#subprocess.run" title="(in Python v3.12)"><code class="xref py py-func docutils literal notranslate"><span class="pre">subprocess.run()</span></code></a> is dependent on the operating
system if <cite>shell=True</cite>. It must hence be a string if <cite>shell=True</cite> and
it should be a sequence (list or tuple) if <cite>shell=False</cite>.</p>
<p><strong>debug</strong> Setting the key <cite>debug</cite> to <cite>True</cite> writes any output of the
external executable to the screen (precisely
<a class="reference external" href="https://docs.python.org/3/library/subprocess.html#subprocess.STDOUT" title="(in Python v3.12)"><code class="xref any docutils literal notranslate"><span class="pre">subprocess.STDOUT</span></code></a>). This especially prints out any errors
that might occur during execution of the executable <cite>exe</cite>. The above
example using the external Python program <cite>rastrigin.py</cite> can be
debugged as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">opt</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">exe_wrapper</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">standard_parameter_writer</span><span class="p">,</span> <span class="n">standard_output_reader</span>

<span class="n">rastrigin_exe</span>   <span class="o">=</span> <span class="s1">&#39;python3 rastrigin.py&#39;</span>
<span class="n">parameterfile</span>   <span class="o">=</span> <span class="s1">&#39;params.txt&#39;</span>
<span class="n">parameterwriter</span> <span class="o">=</span> <span class="n">standard_parameter_writer</span>
<span class="n">outputfile</span>      <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span>
<span class="n">outputreader</span>    <span class="o">=</span> <span class="n">standard_output_reader</span>
<span class="n">rastrigin_wrap</span>  <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">rastrigin_exe</span><span class="p">,</span>
                          <span class="n">parameterfile</span><span class="p">,</span> <span class="n">parameterwriter</span><span class="p">,</span>
                          <span class="n">outputfile</span><span class="p">,</span> <span class="n">outputreader</span><span class="p">,</span>
                          <span class="p">{</span><span class="s1">&#39;shell&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<span class="n">x0</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">rastrigin_wrap</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;BFGS&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Note the change from <cite>rastrigin_exe = [‘python3’, ‘rastrigin.py’]</cite> at
the earlier example to <cite>rastrigin_exe = ‘python3 rastrigin.py’</cite> here
due to the use of <cite>shell=True</cite>.</p>
<p><strong>keepparameterfile, keepoutputfile</strong> Both, <cite>parameterfile</cite> and
<cite>outputfile</cite> can either be single filenames (string) or a list of
filenames, which will be passed to <cite>parameterwriter</cite> and
<cite>outputreader</cite>, respectively.
<a class="reference internal" href="wrappers.html#partialwrap.wrappers.exe_wrapper" title="partialwrap.wrappers.exe_wrapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code></a> deletes the parameter and
output files on disk after use. If one wants to keep the files, one can
set the keys <cite>keepparameterfile</cite> and <cite>keepoutputfile</cite> to <cite>True</cite>. This
can be useful, for example, if the <cite>parameterwriter</cite> just changes a
parameterfile in-place. An example of such a <cite>parameterwriter</cite> is
<a class="reference internal" href="std_io.html#partialwrap.std_io.sub_params_names" title="partialwrap.std_io.sub_params_names"><code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_names()</span></code></a>, which substitutes all
lines <cite>name = .*</cite> with <cite>name = parameter</cite> in the parameter file(s). An
input to <a class="reference internal" href="std_io.html#partialwrap.std_io.sub_params_names" title="partialwrap.std_io.sub_params_names"><code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_names()</span></code></a> could be a
<cite>parameterfile</cite> for the external executable <cite>exe</cite> in which a parameter
is given as <cite>parameter_name = parameter_value</cite>. This is, for example,
the case in Fortran namelists or files for Python’s standard
<a class="reference external" href="https://docs.python.org/3/library/configparser.html#module-configparser" title="(in Python v3.12)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">configparser</span></code></a>. Imagine an optimization of the external
executable <cite>exe</cite> with such a <cite>parameterwriter</cite> and
<a class="reference internal" href="wrappers.html#partialwrap.wrappers.exe_wrapper" title="partialwrap.wrappers.exe_wrapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code></a> deleting the parameter file
after use. In the first iteration, the <cite>parameterwriter</cite> would take
the <cite>parameterfile</cite> and change its content. The <cite>exe</cite> would be run,
the output read by <cite>outputreader</cite>, and then
<a class="reference internal" href="wrappers.html#partialwrap.wrappers.exe_wrapper" title="partialwrap.wrappers.exe_wrapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code></a> would delete
<cite>parameterfile</cite>. So there would be no <cite>parameterfile</cite> file anymore in
the second iteration that <cite>parameterwriter</cite> could change. In this
case, one can set <cite>keepparameterfile = True</cite> and
<a class="reference internal" href="wrappers.html#partialwrap.wrappers.exe_wrapper" title="partialwrap.wrappers.exe_wrapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code></a> would not delete the
<cite>parameterfile</cite> after use.</p>
<p><strong>pargs, pkwargs</strong> The parameterwriter
<a class="reference internal" href="std_io.html#partialwrap.std_io.sub_params_names" title="partialwrap.std_io.sub_params_names"><code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_names()</span></code></a> not only needs the
filename(s) <cite>parameterfile</cite> and the parameter values <cite>params</cite> but also
the <cite>names</cite> of the parameters. One can pass additionally arguments
<cite>pargs</cite> and keyword arguments <cite>pkwargs</cite> to the <cite>parameterwriter</cite> by
passing the dictionary entries <cite>‘pargs’: parameterwriter_arguments</cite>
and <cite>‘pkwargs’: parameterwriter_keywords</cite> to
<a class="reference internal" href="wrappers.html#partialwrap.wrappers.exe_wrapper" title="partialwrap.wrappers.exe_wrapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code></a>.</p>
<p>Let’s change the above external Python program <cite>rastrigin.py</cite>,
calling it <cite>rastrigin_config.py</cite>, so that it reads its parameters from an
input file of the form <cite>name = parameter</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># File: params.txt
  param01 = 0.1 ! Fortran comment
param03   = 0.3 # Python comment
 param02 = 0.2  // C comment
</pre></div>
</div>
<p>The parameter names are not aligned in the above example to
demonstrate that whitespace before the names on the right-hand-side
will be ignored but will be preserved in the changed parameter file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File: rastrigin_config.py</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Rastrigin function a=10, b=2*pi</span>
<span class="k">def</span> <span class="nf">rastrigin</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">10.</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">10.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span><span class="p">))</span>

<span class="c1"># read parameters</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;params.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fi</span><span class="p">:</span>
    <span class="n">pdict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fi</span><span class="p">:</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">pdict</span><span class="p">[</span><span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">pdict</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pdict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="p">])</span>

<span class="c1"># calc function</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">rastrigin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># write output file</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;out.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">ff</span><span class="p">)</span>
</pre></div>
</div>
<p>The parameterwriter <a class="reference internal" href="std_io.html#partialwrap.std_io.sub_params_names" title="partialwrap.std_io.sub_params_names"><code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_names()</span></code></a> will
take the <cite>parameterfile = ‘params.txt’</cite>, searches for the lines that
have nothing but whitespace before the <cite>names = [‘param01’, ‘param02’,
‘param03’]</cite> and replaces the lines with <cite>names[i] = params[i]</cite> for i
in range(len(params)). <cite>params.txt</cite> will be reused for each iteration
during optimization so should not be deleted by
<a class="reference internal" href="wrappers.html#partialwrap.wrappers.exe_wrapper" title="partialwrap.wrappers.exe_wrapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">opt</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">exe_wrapper</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">sub_params_names</span><span class="p">,</span> <span class="n">standard_output_reader</span>

<span class="n">rastrigin_exe</span>   <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span> <span class="s1">&#39;rastrigin_config.py&#39;</span><span class="p">]</span>
<span class="n">parameterfile</span>   <span class="o">=</span> <span class="s1">&#39;params.txt&#39;</span>
<span class="n">parameterwriter</span> <span class="o">=</span> <span class="n">sub_params_names</span>
<span class="n">outputfile</span>      <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span>
<span class="n">outputreader</span>    <span class="o">=</span> <span class="n">standard_output_reader</span>
<span class="n">x0</span>              <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]</span>
<span class="n">names</span>           <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;param01&#39;</span><span class="p">,</span> <span class="s1">&#39;param02&#39;</span><span class="p">,</span> <span class="s1">&#39;param03&#39;</span><span class="p">]</span>
<span class="n">rastrigin_wrap</span>  <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">rastrigin_exe</span><span class="p">,</span>
                          <span class="n">parameterfile</span><span class="p">,</span> <span class="n">parameterwriter</span><span class="p">,</span>
                          <span class="n">outputfile</span><span class="p">,</span> <span class="n">outputreader</span><span class="p">,</span>
                          <span class="p">{</span><span class="s1">&#39;pargs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">names</span><span class="p">],</span> <span class="s1">&#39;keepparameterfile&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">rastrigin_wrap</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;BFGS&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Note <cite>pargs</cite> is given a list <cite>‘pargs’: [names]</cite>, which gives <cite>‘pargs’:
[[‘param01’, ‘param02’, ‘param03’]]</cite>. If one would simply put
<cite>‘pargs’: names</cite>, than the <cite>*args</cite> mechanism would expand the list
<cite>names</cite> to three individual arguments for <cite>sub_params_names</cite>, so that
the latter would receive wrongly 5 instead of 3 arguments.</p>
<p><strong>oargs, okwargs</strong> The same <cite>*args/**kwargs</cite> mechanism is implemented
for the <cite>outputreader</cite>, where one can set the keys <cite>oargs</cite> and
<cite>okwargs</cite> to be passed to <cite>outputreader</cite>. This can be used, for
example, to pass observational data and uncertainty to calculate an
evaluation metric such as a log-likelihood from model output.</p>
<p><strong>pid</strong> This keyword offers another possibility not to delete
<cite>parameterfile</cite> and <cite>outputfile</cite> after use. It is especially useful
with parallel evaluations of external executables <cite>exe</cite> (see
<a class="reference internal" href="#parallel-evaluation">Parallel evaluation</a> below). If <cite>pid = True</cite> is given,
<a class="reference internal" href="wrappers.html#partialwrap.wrappers.exe_wrapper" title="partialwrap.wrappers.exe_wrapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code></a> will write the file
<cite>parameterfile.pid</cite> rather than <cite>parameterfile</cite>, with <cite>pid</cite> being a
random number. It will launch <cite>exe + [str(pid)]</cite> instead of <cite>exe</cite>, and
it will read <cite>outputfile.pid</cite> instead of <cite>outputfile</cite>. The external
executable <cite>exe</cite> has hence to be able to read the <cite>pid</cite> from the
command line, read <cite>parameterfile.pid</cite> instead of <cite>parameterfile</cite> and
write <cite>outputfile.pid</cite> instead of <cite>outputfile</cite>. This can be handled
with shell scripts if one is unable to change the external model code
(also see below).</p>
</section>
<section id="parallel-evaluation">
<h2>Parallel evaluation<a class="headerlink" href="#parallel-evaluation" title="Permalink to this heading">#</a></h2>
<p>Most real-life numerical models have longer run times than just a few
milliseconds. One might hence like to take advantage of more processing units
such as simple multi-core processors, multi-processor nodes or computer
clusters.</p>
<p>One may want to find the minimum of the Rastrigin function in
<cite>rastrigin.py</cite> taking advantage of multiple processors. Scipy’s
<a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.differential_evolution.html#scipy.optimize.differential_evolution" title="(in SciPy v1.11.4)"><code class="xref py py-func docutils literal notranslate"><span class="pre">scipy.optimize.differential_evolution()</span></code></a> has the <em>workers</em>
keyword to use more than one CPU to find the minimum of a
function. One would naively do:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">opt</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">exe_wrapper</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">standard_parameter_writer</span><span class="p">,</span> <span class="n">standard_output_reader</span>

<span class="n">rastrigin_exe</span>   <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span> <span class="s1">&#39;rastrigin.py&#39;</span><span class="p">]</span>
<span class="n">parameterfile</span>   <span class="o">=</span> <span class="s1">&#39;params.txt&#39;</span>
<span class="n">parameterwriter</span> <span class="o">=</span> <span class="n">standard_parameter_writer</span>
<span class="n">outputfile</span>      <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span>
<span class="n">outputreader</span>    <span class="o">=</span> <span class="n">standard_output_reader</span>
<span class="n">rastrigin_wrap</span>  <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">rastrigin_exe</span><span class="p">,</span>
                          <span class="n">parameterfile</span><span class="p">,</span> <span class="n">parameterwriter</span><span class="p">,</span>
                          <span class="n">outputfile</span><span class="p">,</span> <span class="n">outputreader</span><span class="p">,</span> <span class="p">{})</span>
<span class="n">ndim</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="o">-</span><span class="mf">5.12</span><span class="p">,</span> <span class="mf">5.12</span><span class="p">),]</span> <span class="o">*</span> <span class="n">ndim</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">differential_evolution</span><span class="p">(</span><span class="n">rastrigin_wrap</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<p>This subdivides the population into 4 worker sections and evaluates
them in parallel (using <code class="xref py py-func docutils literal notranslate"><span class="pre">multiprocessing.Pool()</span></code>). This means
<cite>rastrigin.py</cite> will be launched 4 times in parallel, each writing a
<cite>parameterfile</cite> <em>params.txt</em>, hence overwriting each other all the
time. Here the <cite>pid</cite> keyword comes in handy. Each invocation of <cite>rastrigin.py</cite> would have its own random number <cite>pid</cite> associated, writing <cite>parameterfile.pid</cite> and reading <cite>outfile.pid</cite>. The rastrigin program would need to be changed to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File: rastrigin_pid.py</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">standard_parameter_reader</span>

<span class="c1"># Rastrigin function a=10, b=2*pi</span>
<span class="k">def</span> <span class="nf">rastrigin</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">10.</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">10.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span><span class="p">))</span>

<span class="c1"># get pid</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># read parameters</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">standard_parameter_reader</span><span class="p">(</span><span class="s1">&#39;params.txt&#39;</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="n">pid</span><span class="p">)</span>

<span class="c1"># calc function</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">rastrigin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># write output file</span>
<span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;out.txt.</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">ff</span><span class="p">)</span>
</pre></div>
</div>
<p>All input/output routines provided by <code class="docutils literal notranslate"><span class="pre">partialwrap</span></code> take a keyword
<cite>pid</cite> and, if present, read or write <cite>file.pid</cite> rather than <cite>file</cite>
with <em>pid</em> being a unique random number. So here
<a class="reference internal" href="std_io.html#partialwrap.std_io.standard_parameter_reader" title="partialwrap.std_io.standard_parameter_reader"><code class="xref py py-func docutils literal notranslate"><span class="pre">standard_parameter_reader()</span></code></a> reads from files
such as <cite>params.txt.158398716</cite> rather than from <cite>params.txt</cite>. Then simply the <cite>pid</cite> keyword has to be set to <em>True</em> in the call of <cite>partial</cite>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">opt</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">exe_wrapper</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">standard_parameter_writer</span><span class="p">,</span> <span class="n">standard_output_reader</span>

<span class="n">rastrigin_exe</span>   <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span> <span class="s1">&#39;rastrigin_pid.py&#39;</span><span class="p">]</span>
<span class="n">parameterfile</span>   <span class="o">=</span> <span class="s1">&#39;params.txt&#39;</span>
<span class="n">parameterwriter</span> <span class="o">=</span> <span class="n">standard_parameter_writer</span>
<span class="n">outputfile</span>      <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span>
<span class="n">outputreader</span>    <span class="o">=</span> <span class="n">standard_output_reader</span>
<span class="n">rastrigin_wrap</span>  <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">rastrigin_exe</span><span class="p">,</span>
                          <span class="n">parameterfile</span><span class="p">,</span> <span class="n">parameterwriter</span><span class="p">,</span>
                          <span class="n">outputfile</span><span class="p">,</span> <span class="n">outputreader</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;pid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<span class="n">ndim</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="o">-</span><span class="mf">5.12</span><span class="p">,</span> <span class="mf">5.12</span><span class="p">),]</span> <span class="o">*</span> <span class="n">ndim</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">differential_evolution</span><span class="p">(</span><span class="n">rastrigin_wrap</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<p>Another example could use the popular <a class="reference external" href="https://emcee.readthedocs.io/en/latest/">emcee</a> library to calculate
parameter uncertainties with the Markov chain Monte Carlo (MCMC)
method. We take the example from the section on parallelization of the
<a class="reference external" href="https://emcee.readthedocs.io/en/latest/">emcee</a> documentation
(<a class="reference external" href="https://emcee.readthedocs.io/en/stable/tutorials/parallel/">https://emcee.readthedocs.io/en/stable/tutorials/parallel/</a>) but code
the log-likelihood function as an external Python program:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File: logli.py</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">standard_parameter_reader</span>

<span class="c1"># log-likelihood</span>
<span class="k">def</span> <span class="nf">log_prob</span><span class="p">(</span><span class="n">theta</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">theta</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># get pid</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># read parameters</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">standard_parameter_reader</span><span class="p">(</span><span class="s1">&#39;params.txt&#39;</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="n">pid</span><span class="p">)</span>

<span class="c1"># calc function</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">log_prob</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># write output file</span>
<span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;out.txt.</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">ff</span><span class="p">)</span>
</pre></div>
</div>
<p>Partialize it and sample the log-likelihood with <a class="reference external" href="https://emcee.readthedocs.io/en/latest/">emcee</a> using a single processor:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">exe_wrapper</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">standard_parameter_writer</span><span class="p">,</span> <span class="n">standard_output_reader</span>
<span class="kn">import</span> <span class="nn">emcee</span>

<span class="n">logli_exe</span>     <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span> <span class="s1">&#39;logli.py&#39;</span><span class="p">]</span>
<span class="n">parameterfile</span>   <span class="o">=</span> <span class="s1">&#39;params.txt&#39;</span>
<span class="n">parameterwriter</span> <span class="o">=</span> <span class="n">standard_parameter_writer</span>
<span class="n">outputfile</span>      <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span>
<span class="n">outputreader</span>    <span class="o">=</span> <span class="n">standard_output_reader</span>
<span class="n">logli_wrap</span>      <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">logli_exe</span><span class="p">,</span>
                          <span class="n">parameterfile</span><span class="p">,</span> <span class="n">parameterwriter</span><span class="p">,</span>
                          <span class="n">outputfile</span><span class="p">,</span> <span class="n">outputreader</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;pid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<span class="c1"># MCMC</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">initial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">nwalkers</span><span class="p">,</span> <span class="n">ndim</span> <span class="o">=</span> <span class="n">initial</span><span class="o">.</span><span class="n">shape</span>
<span class="n">nsteps</span>  <span class="o">=</span> <span class="mi">8</span>

<span class="c1"># Single processor version</span>
<span class="n">sampler</span> <span class="o">=</span> <span class="n">emcee</span><span class="o">.</span><span class="n">EnsembleSampler</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">logli_wrap</span><span class="p">)</span>
<span class="n">sampler</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>or use multiple processors by changing the last two lines to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="k">with</span> <span class="n">Pool</span><span class="p">()</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
    <span class="n">sampler</span> <span class="o">=</span> <span class="n">emcee</span><span class="o">.</span><span class="n">EnsembleSampler</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">logli_wrap</span><span class="p">,</span> <span class="n">pool</span><span class="o">=</span><span class="n">pool</span><span class="p">)</span>
    <span class="n">sampler</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The serial version takes about 40 seconds on my machine, while the parallel version takes about 6 seconds with 16 cores on my machine.</p>
</section>
<section id="using-launch-scripts">
<h2>Using launch scripts<a class="headerlink" href="#using-launch-scripts" title="Permalink to this heading">#</a></h2>
<p>If one cannot change the external program to use a process identifier
<cite>pid</cite> from the command line (i.e. using <cite>rastrigin_pid.py</cite>), one can use
a launch script that deals with <cite>pid</cite> by creating individual
directories for each model run and moving and renaming <cite>parameterfile</cite>
and <cite>outputfile</cite>. The program <cite>rastrigini1.py</cite>, which has no <cite>pid</cite>
ability, could still be used using a bash script on Unix/Linux and macOS:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># File: rastrigin.sh</span>
<span class="c1">#!/usr/bin/env bash</span>
<span class="nb">set</span><span class="w"> </span>-e

<span class="c1"># get pid</span>
<span class="nv">pid</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span>

<span class="nv">exe</span><span class="o">=</span>rastrigin.py
<span class="nv">pfile</span><span class="o">=</span>params.txt
<span class="nv">ofile</span><span class="o">=</span>out.txt

<span class="c1"># make individual run directory</span>
<span class="nv">rundir</span><span class="o">=</span>tmp.<span class="si">${</span><span class="nv">pid</span><span class="si">}</span>
mkdir<span class="w"> </span><span class="si">${</span><span class="nv">rundir</span><span class="si">}</span>

<span class="c1"># copy individual parameter file</span>
mv<span class="w"> </span><span class="si">${</span><span class="nv">pfile</span><span class="si">}</span>.<span class="si">${</span><span class="nv">pid</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">rundir</span><span class="si">}</span>/<span class="si">${</span><span class="nv">pfile</span><span class="si">}</span>

<span class="c1"># run in individual directory</span>
<span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">rundir</span><span class="si">}</span>
ln<span class="w"> </span>-s<span class="w"> </span>../<span class="si">${</span><span class="nv">exe</span><span class="si">}</span>
python3<span class="w"> </span><span class="si">${</span><span class="nv">exe</span><span class="si">}</span>

<span class="c1"># individualize output file</span>
mv<span class="w"> </span><span class="si">${</span><span class="nv">ofile</span><span class="si">}</span><span class="w"> </span>../<span class="si">${</span><span class="nv">ofile</span><span class="si">}</span>.<span class="si">${</span><span class="nv">pid</span><span class="si">}</span>

<span class="c1"># clean up</span>
<span class="nb">cd</span><span class="w"> </span>..
rm<span class="w"> </span>-r<span class="w"> </span><span class="si">${</span><span class="nv">rundir</span><span class="si">}</span>
</pre></div>
</div>
<p>This would be used with <a class="reference internal" href="wrappers.html#partialwrap.wrappers.exe_wrapper" title="partialwrap.wrappers.exe_wrapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code></a>
in exactly the same way as above:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">opt</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">exe_wrapper</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">standard_parameter_writer</span><span class="p">,</span> <span class="n">standard_output_reader</span>

<span class="n">rastrigin_exe</span>   <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rastrigin.sh&#39;</span><span class="p">]</span>
<span class="n">parameterfile</span>   <span class="o">=</span> <span class="s1">&#39;params.txt&#39;</span>
<span class="n">parameterwriter</span> <span class="o">=</span> <span class="n">standard_parameter_writer</span>
<span class="n">outputfile</span>      <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span>
<span class="n">outputreader</span>    <span class="o">=</span> <span class="n">standard_output_reader</span>
<span class="n">rastrigin_wrap</span>  <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">rastrigin_exe</span><span class="p">,</span>
                          <span class="n">parameterfile</span><span class="p">,</span> <span class="n">parameterwriter</span><span class="p">,</span>
                          <span class="n">outputfile</span><span class="p">,</span> <span class="n">outputreader</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;pid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<span class="n">ndim</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="o">-</span><span class="mf">5.12</span><span class="p">,</span> <span class="mf">5.12</span><span class="p">),]</span> <span class="o">*</span> <span class="n">ndim</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">differential_evolution</span><span class="p">(</span><span class="n">rastrigin_wrap</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<p>The bash script could, of course, also be a Python script to work
on Windows platforms as well:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File: run_rastrigin.py</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1"># get pid</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">exe</span>   <span class="o">=</span> <span class="s1">&#39;rastrigin.py&#39;</span>
<span class="n">pfile</span> <span class="o">=</span> <span class="s1">&#39;params.txt&#39;</span>
<span class="n">ofile</span> <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span>

<span class="c1"># make individual run directory</span>
<span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">rundir</span> <span class="o">=</span> <span class="s1">&#39;tmp&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">rundir</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;tmp.</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">rundir</span><span class="p">)</span>

<span class="c1"># copy individual parameter file</span>
<span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rundir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">pfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pfile</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rundir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">pfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># run in individual directory</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">exe</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rundir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">exe</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">rundir</span><span class="p">)</span>
<span class="n">err</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span> <span class="n">exe</span><span class="p">],</span>
                              <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>

<span class="c1"># make output available to exe_wrapper</span>
<span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">ofile</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;../</span><span class="si">{</span><span class="n">ofile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">ofile</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;../</span><span class="si">{</span><span class="n">ofile</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># clean up</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">rundir</span><span class="p">)</span>
</pre></div>
</div>
<p>This Python script could be used exactly as the shell script above:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">opt</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">exe_wrapper</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">standard_parameter_writer</span><span class="p">,</span> <span class="n">standard_output_reader</span>

<span class="n">rastrigin_exe</span>   <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span> <span class="s1">&#39;run_rastrigin.py&#39;</span><span class="p">]</span>
<span class="n">parameterfile</span>   <span class="o">=</span> <span class="s1">&#39;params.txt&#39;</span>
<span class="n">parameterwriter</span> <span class="o">=</span> <span class="n">standard_parameter_writer</span>
<span class="n">outputfile</span>      <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span>
<span class="n">outputreader</span>    <span class="o">=</span> <span class="n">standard_output_reader</span>
<span class="n">rastrigin_wrap</span>  <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">rastrigin_exe</span><span class="p">,</span>
                          <span class="n">parameterfile</span><span class="p">,</span> <span class="n">parameterwriter</span><span class="p">,</span>
                          <span class="n">outputfile</span><span class="p">,</span> <span class="n">outputreader</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;pid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<span class="n">ndim</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="o">-</span><span class="mf">5.12</span><span class="p">,</span> <span class="mf">5.12</span><span class="p">),]</span> <span class="o">*</span> <span class="n">ndim</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">differential_evolution</span><span class="p">(</span><span class="n">rastrigin_wrap</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="input-output-functions">
<h2>Input/Output functions<a class="headerlink" href="#input-output-functions" title="Permalink to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">partialwrap</span></code> comes with a few read and write routines for
parameters and output. All routines support the <cite>pid</cite> keyword,
i.e. take the <cite>pid=something</cite> keyword argument and use <cite>something</cite>, if
present, to suffix the input file(s) with it on output. The provided
input/output routines are seen as examples on which one can build its
own tailored input/output functions.</p>
<p><strong>standard_output_reader</strong>
<a class="reference internal" href="std_io.html#partialwrap.std_io.standard_output_reader" title="partialwrap.std_io.standard_output_reader"><code class="xref py py-func docutils literal notranslate"><span class="pre">standard_output_reader()</span></code></a> reads a single
value from a file. For example:</p>
<blockquote>
<div><div class="line-block">
<div class="line">0.123456789</div>
</div>
</div></blockquote>
<p><strong>standard_parameter_reader</strong>
<a class="reference internal" href="std_io.html#partialwrap.std_io.standard_parameter_reader" title="partialwrap.std_io.standard_parameter_reader"><code class="xref py py-func docutils literal notranslate"><span class="pre">standard_parameter_reader()</span></code></a> reads parameters
from a file, one parameter per line. For example:</p>
<blockquote>
<div><div class="line-block">
<div class="line">0.1</div>
<div class="line">0.3</div>
<div class="line">0.2</div>
<div class="line">…</div>
</div>
</div></blockquote>
<p><strong>standard_parameter_writer</strong>
<a class="reference internal" href="std_io.html#partialwrap.std_io.standard_parameter_writer" title="partialwrap.std_io.standard_parameter_writer"><code class="xref py py-func docutils literal notranslate"><span class="pre">standard_parameter_writer()</span></code></a> writes one
parameter per line into a file. For example:</p>
<blockquote>
<div><div class="line-block">
<div class="line">1.000000000000000e-01</div>
<div class="line">3.000000000000000e-01</div>
<div class="line">2.000000000000000e-01</div>
<div class="line">…</div>
</div>
</div></blockquote>
<p><strong>standard_time_series_reader, standard_timeseries_reader</strong>
<a class="reference internal" href="std_io.html#partialwrap.std_io.standard_timeseries_reader" title="partialwrap.std_io.standard_timeseries_reader"><code class="xref py py-func docutils literal notranslate"><span class="pre">standard_timeseries_reader()</span></code></a> (or
<a class="reference internal" href="std_io.html#partialwrap.std_io.standard_time_series_reader" title="partialwrap.std_io.standard_time_series_reader"><code class="xref py py-func docutils literal notranslate"><span class="pre">standard_time_series_reader()</span></code></a>) reads all
lines from an output file into a <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.26)"><code class="xref py py-class docutils literal notranslate"><span class="pre">numpy.ndarray</span></code></a>. For example:</p>
<blockquote>
<div><div class="line-block">
<div class="line">0.123456789</div>
<div class="line">0.234567890</div>
<div class="line">0.345678901</div>
<div class="line">…</div>
</div>
</div></blockquote>
<p><strong>standard_parameter_reader_bounds_mask</strong>
<a class="reference internal" href="std_io.html#partialwrap.std_io.standard_parameter_reader_bounds_mask" title="partialwrap.std_io.standard_parameter_reader_bounds_mask"><code class="xref py py-func docutils literal notranslate"><span class="pre">standard_parameter_reader_bounds_mask()</span></code></a>
reads a common parameter file format. It has one header line (# value
min max mask) plus one line per parameter with the following columns:
consecutive parameter number, current parameter value, lower bound of
parameter, upper bound of parameter, 0/1 mask. For example:</p>
<blockquote>
<div><div class="line-block">
<div class="line"># value min max mask</div>
<div class="line">1 3.0e-01 0.0 1. 1</div>
<div class="line">2 2.3e-01 -1.0 1. 1</div>
<div class="line">3 1.44e+01 9.0 20. 1</div>
<div class="line">4 3.0e-01 0.0 1. 0</div>
<div class="line">…</div>
</div>
</div></blockquote>
<p><strong>standard_parameter_writer_bounds_mask</strong>
<a class="reference internal" href="std_io.html#partialwrap.std_io.standard_parameter_writer_bounds_mask" title="partialwrap.std_io.standard_parameter_writer_bounds_mask"><code class="xref py py-func docutils literal notranslate"><span class="pre">standard_parameter_writer_bounds_mask()</span></code></a> writes a
parameter file with values, bound and mask. It has one header line (#
value min max mask) plus one line per parameter with the following
columns: consecutive parameter number, current parameter value, lower
bound of parameter, upper bound of parameter, 0/1 mask. For example:</p>
<blockquote>
<div><div class="line-block">
<div class="line"># value min max mask</div>
<div class="line">1 3.000000000000000e-01 0.000000000000000e+00 1.000000000000000e+00 1</div>
<div class="line">2 2.300000000000000e-01 -1.000000000000000e+00 1.000000000000000e+00 1</div>
<div class="line">3 1.440000000000000e+01 9.000000000000000e+00 2.000000000000000e+01 1</div>
<div class="line">4 3.000000000000000e-01 0.000000000000000e+00 1.000000000000000e+00 0</div>
<div class="line">…</div>
</div>
</div></blockquote>
<p><strong>sub_params_names, sub_params_names_ignorecase</strong>
<a class="reference internal" href="std_io.html#partialwrap.std_io.sub_params_names" title="partialwrap.std_io.sub_params_names"><code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_names()</span></code></a> (or
<a class="reference internal" href="std_io.html#partialwrap.std_io.sub_params_names_ignorecase" title="partialwrap.std_io.sub_params_names_ignorecase"><code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_names_ignorecase()</span></code></a>) substitutes
<cite>name = .*</cite> with <cite>name = parameter</cite> in input file(s); names are case
insensitive. It searches the input file(s) for lines that have nothing
but whitespace before given <cite>names</cite> and replaces the right hand side
of the equal sign with the parameter value. An input to
<a class="reference internal" href="std_io.html#partialwrap.std_io.sub_params_names" title="partialwrap.std_io.sub_params_names"><code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_names()</span></code></a> could be a
<cite>parameterfile</cite> in which a parameters are given as <cite>parameter_name =
parameter_value</cite>. This is, for example, the case in Fortran
namelists. For example:</p>
<blockquote>
<div><div class="line-block">
<div class="line">&amp;parameters</div>
<div class="line-block">
<div class="line">param01 = 0.1 ! Fortran comment</div>
</div>
<div class="line">Param03   = 0.3</div>
<div class="line-block">
<div class="line">PaRaM02 = 0.2</div>
</div>
<div class="line">/</div>
</div>
</div></blockquote>
<p><strong>sub_params_names_case</strong>
<a class="reference internal" href="std_io.html#partialwrap.std_io.sub_params_names_case" title="partialwrap.std_io.sub_params_names_case"><code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_names_case()</span></code></a> substitutes <cite>name =
.*</cite> with <cite>name = parameter</cite> in input file(s); names are case
sensitive. It is the same as
<a class="reference internal" href="std_io.html#partialwrap.std_io.sub_params_names_ignorecase" title="partialwrap.std_io.sub_params_names_ignorecase"><code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_names_ignorecase()</span></code></a> but <cite>names</cite>
are case sensitive. An example input file are files for Python’s
standard <a class="reference external" href="https://docs.python.org/3/library/configparser.html#module-configparser" title="(in Python v3.12)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">configparser</span></code></a>. For example:</p>
<blockquote>
<div><div class="line-block">
<div class="line">[Parameters]</div>
<div class="line-block">
<div class="line">param01 = 0.1</div>
</div>
<div class="line">Param03   = 0.3 # Python comment</div>
<div class="line-block">
<div class="line">PaRaM02 = 0.2</div>
</div>
</div>
</div></blockquote>
<p><strong>sub_params_ja</strong> <a class="reference internal" href="std_io.html#partialwrap.std_io.sub_params_ja" title="partialwrap.std_io.sub_params_ja"><code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_ja()</span></code></a>
substitutes the strings <em>#JA0000#</em>, <em>#JA0001#</em>, … in the input
file(s) with the parameter values. It searches for the tags
<em>#JA0000#</em>, <em>#JA0001#</em>, … in the input file(s) and replaces them
with the values of the first parameter, the second parameter, and so
on. The file must be prepared in advance and the parameters can then
be anywhere in the file(s), appear several times on the same line or
on different lines, etc. For example:</p>
<blockquote>
<div><div class="line-block">
<div class="line">&amp;parameters</div>
<div class="line-block">
<div class="line">param01 = #JA0000#</div>
<div class="line">param02 = 0.3</div>
<div class="line">Param03 = #JA0001#, #JA0001#, #JA0001#</div>
</div>
<div class="line">/</div>
</div>
</div></blockquote>
<p>The substitution functions
<a class="reference internal" href="std_io.html#partialwrap.std_io.sub_params_names" title="partialwrap.std_io.sub_params_names"><code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_names()</span></code></a>,
<a class="reference internal" href="std_io.html#partialwrap.std_io.sub_params_names_ignorecase" title="partialwrap.std_io.sub_params_names_ignorecase"><code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_names_ignorecase()</span></code></a>,
<a class="reference internal" href="std_io.html#partialwrap.std_io.sub_params_names_case" title="partialwrap.std_io.sub_params_names_case"><code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_names_case()</span></code></a>, and
<a class="reference internal" href="std_io.html#partialwrap.std_io.sub_params_ja" title="partialwrap.std_io.sub_params_ja"><code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_ja()</span></code></a> change the input
file(s). <a class="reference internal" href="wrappers.html#partialwrap.wrappers.exe_wrapper" title="partialwrap.wrappers.exe_wrapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code></a> deletes files after
use by default. The best way to use the substitution functions is
hence with <cite>‘keepparameterfile’: True</cite> or <cite>‘pid’: True</cite>. The last
function <a class="reference internal" href="std_io.html#partialwrap.std_io.sub_params_ja" title="partialwrap.std_io.sub_params_ja"><code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_ja()</span></code></a> substitutes the
tags <em>#JA0000#</em>, <em>#JA0001#</em>, … in the input file(s). Once
substituted, the tags would not be in the input files anymore. Hence
this does not work with <cite>‘keepparameterfile’: True</cite> but rather works
with only with <cite>‘pid’: True</cite>.</p>
</section>
<section id="python-functions">
<h2>Python functions<a class="headerlink" href="#python-functions" title="Permalink to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">partialwrap</span></code> has also two convenience functions to do the same
mechanisms with Python functions:
<a class="reference internal" href="wrappers.html#partialwrap.wrappers.function_wrapper" title="partialwrap.wrappers.function_wrapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">function_wrapper()</span></code></a> and
<a class="reference internal" href="wrappers.html#partialwrap.wrappers.function_mask_wrapper" title="partialwrap.wrappers.function_mask_wrapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">function_mask_wrapper()</span></code></a>. They can, for
example, be used during development of a complex code as substitution
for the exe-equivalents.</p>
<p>Take the Python function <em>rastrigin</em>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">def</span> <span class="nf">rastrigin</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mf">2.</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
<p>It’s minimum can be found with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">opt</span>

<span class="n">x0</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">rastrigin</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;BFGS&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The minimizer <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html#scipy.optimize.minimize" title="(in SciPy v1.11.4)"><code class="xref py py-func docutils literal notranslate"><span class="pre">minimize()</span></code></a> can pass arguments to
the function <em>rastrigin</em> but does not has the functionality to pass
keyword parameters. It is hence <em>a priori</em> not possible to search the
minimum of the Rastrigin function with another <span class="math notranslate nohighlight">\(b\)</span>
parameter. (This is an illustrative example while it is, of course,
possible to just pass <cite>b</cite> as a second argument in this case.) One
could use Python’s <a class="reference external" href="https://docs.python.org/3/library/functools.html#functools.partial" title="(in Python v3.12)"><code class="xref py py-func docutils literal notranslate"><span class="pre">functools.partial()</span></code></a> in this case:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">opt</span>

<span class="c1"># helper function</span>
<span class="k">def</span> <span class="nf">call_func_arg_kwarg</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>

<span class="c1"># Partialise function with fixed parameters</span>
<span class="n">a</span> <span class="o">=</span> <span class="mf">5.</span>
<span class="n">b</span> <span class="o">=</span> <span class="mf">4.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">partial_rastrigin</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">call_func_arg_kwarg</span><span class="p">,</span> <span class="n">rastrigin</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="n">x0</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">partial_rastrigin</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;BFGS&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">partialwrap</span></code> provides a convenience function
<a class="reference internal" href="wrappers.html#partialwrap.wrappers.function_wrapper" title="partialwrap.wrappers.function_wrapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">function_wrapper()</span></code></a> that generalises the
above helper function <cite>call_func_arg_kwarg</cite> by passing all arguments,
given as a <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#list" title="(in Python v3.12)"><code class="xref any docutils literal notranslate"><span class="pre">list</span></code></a>, and keyword arguments, given as a <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.12)"><code class="xref any docutils literal notranslate"><span class="pre">dict</span></code></a>,
to arbitrary functions by the usual <cite>*args</cite>, <cite>**kwargs</cite> mechanism:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">opt</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">function_wrapper</span>

<span class="c1"># Partialise function with fixed parameters</span>
<span class="n">args</span>   <span class="o">=</span> <span class="p">[</span><span class="mf">5.</span><span class="p">]</span>
<span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mf">4.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">}</span>
<span class="n">rastrigin_wrap</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">function_wrapper</span><span class="p">,</span> <span class="n">rastrigin</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

<span class="n">x0</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">rastrigin_wrap</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;BFGS&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that one passes <cite>args</cite> and <cite>kwargs</cite> and not <cite>*args</cite> and <cite>**kwargs</cite>
to <a class="reference external" href="https://docs.python.org/3/library/functools.html#functools.partial" title="(in Python v3.12)"><code class="xref py py-func docutils literal notranslate"><span class="pre">partial()</span></code></a>.</p>
<p>There is also the masked version
<a class="reference internal" href="wrappers.html#partialwrap.wrappers.function_mask_wrapper" title="partialwrap.wrappers.function_mask_wrapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">function_mask_wrapper()</span></code></a> to exclude some
parameters from optimization. For example fixing the second parameter
to a default value of 0.0001 changes the above to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">opt</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">function_mask_wrapper</span>

<span class="c1"># Partialise function with fixed parameters</span>
<span class="n">args</span>   <span class="o">=</span> <span class="p">[</span><span class="mf">5.</span><span class="p">]</span>
<span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mf">4.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">}</span>
<span class="n">x0</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
<span class="c1"># Do not optimize the second parameter but take its initial value 0.0001</span>
<span class="n">mask</span>   <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
<span class="n">rastrigin_wrap</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">function_mask_wrapper</span><span class="p">,</span> <span class="n">rastrigin</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span>
                         <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">rastrigin_wrap</span><span class="p">,</span> <span class="n">x0</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;BFGS&#39;</span><span class="p">)</span>
<span class="n">xout</span>       <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">xout</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
</pre></div>
</div>
</section>
<section id="a-real-life-example">
<h2>A real life example<a class="headerlink" href="#a-real-life-example" title="Permalink to this heading">#</a></h2>
<p>We use the ecosystem model <a class="reference external" href="https://ecofun.ispa.bordeaux.inrae.fr/index.php/musica-model/">MuSICA</a> in our research. The model is
written in Fortran and uses so-called namelists for configuration,
which look like this:</p>
<blockquote>
<div><div class="line-block">
<div class="line">&amp;namelist_01</div>
<div class="line-block">
<div class="line">parameter01 = 3.141592653589793</div>
<div class="line">parameter02 = 1, 1, 2, 3, 5, 8, 13</div>
</div>
<div class="line">/</div>
<div class="line"><br /></div>
<div class="line">&amp;namelist_02</div>
<div class="line-block">
<div class="line">another_parameter01 = 2.718281828459045</div>
<div class="line">another_parameter02 = ‘equilibrium’</div>
</div>
<div class="line">/</div>
</div>
</div></blockquote>
<p>The namelists are organized in three files: <em>musica.nml</em>,
<em>musica_soil.nml</em>, and one file for each tree species modelled, for
example, <em>fagus_sylvatica.nml</em>. There are about 50 parameters in the
namelists that influence the model output.</p>
<p><a class="reference external" href="https://ecofun.ispa.bordeaux.inrae.fr/index.php/musica-model/">MuSICA</a> calculates energy, water, and carbon fluxes in an ecosystem
such as a forest. One primary output is so-called Net Ecosystem
Exchange (NEE). One might want to adapt a few parameters, which were
not measured, for a specific forest stand by optimizing model output
against observed NEE. Below is a documented Python program that
optimizes three parameters for the description of stomatal conductance
in MuSICA: <em>gs_slope</em>, <em>gs_hx_half</em>, and <em>gs_hx_shape</em>. The first one
is the empirical slope in the description of stomatal conductance <em>gs</em>
(Ball-Berry <em>m</em> or Medlyn <em>g1</em>, for example) and the other two
variables are the parameters of a logistic function that links
stomatal conductance <em>gs</em> with the water potential in the xylem <em>hx</em>
(Tuzet model). Here I prepared the namelist file fagus_sylvatica.nml
and put tags <em>#JA0000#</em>, <em>#JA0001#</em>, and <em>#JA0002#</em> instead of values
on the right-hand-side of the equal sign and will then use the
substitution function <a class="reference internal" href="std_io.html#partialwrap.std_io.sub_params_ja" title="partialwrap.std_io.sub_params_ja"><code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_ja()</span></code></a>:</p>
<blockquote>
<div><div class="line-block">
<div class="line">&amp;leaflevelctl</div>
<div class="line">…</div>
<div class="line">! slope of stomata model</div>
<div class="line">GS_SLOPE = #JA0000#</div>
<div class="line">! intercept of stomata model</div>
<div class="line">GS_INTERCEPT = 1.e-3</div>
<div class="line">! minimum stomatal conductance</div>
<div class="line">GS_MIN = 1.e-3  ! check influence on very dry sites</div>
<div class="line">! Tuzet parameters</div>
<div class="line">GS_HX_HALF = #JA0001#</div>
<div class="line">GS_HX_SHAPE = #JA0002#</div>
<div class="line">…</div>
<div class="line">/</div>
</div>
</div></blockquote>
<p>The Python program for optimizing <em>gs_slope</em>, <em>gs_hx_half</em>, and
<em>gs_hx_shape</em> uses the Root Mean Square Error (RMSE) between modelled
and observed NEE:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File: optimize_musica.py</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">opt</span>
<span class="kn">import</span> <span class="nn">netCDF4</span> <span class="k">as</span> <span class="nn">nc</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">sub_params_ja</span>

<span class="c1">#</span>
<span class="c1"># Functions</span>
<span class="c1">#</span>

<span class="c1"># Read NEE from MuSICA&#39;s netCDF output</span>
<span class="k">def</span> <span class="nf">read_model_nee</span><span class="p">(</span><span class="n">ofile</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">nc</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">ofile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fi</span><span class="p">:</span>
        <span class="n">nee</span> <span class="o">=</span> <span class="n">fi</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;nee&#39;</span><span class="p">][:]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">nee</span>

<span class="c1"># The objective: RMSE(obs, mod)</span>
<span class="k">def</span> <span class="nf">rmse</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">mod</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">obs</span> <span class="o">-</span> <span class="n">mod</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

<span class="c1"># RMSE given the output file and the observations</span>
<span class="k">def</span> <span class="nf">calc_rmse</span><span class="p">(</span><span class="n">ofile</span><span class="p">,</span> <span class="n">obs</span><span class="p">):</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">read_model_nee</span><span class="p">(</span><span class="n">ofile</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rmse</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">mod</span><span class="p">)</span>

<span class="c1"># Read NEE observations</span>
<span class="c1"># Assume a csv file such as submitted to europe-fluxdata.org</span>
<span class="c1">#   TIMESTAMP_END,H_1_1_1,LE_1_1_1,FC_1_1_1,FC_SSITC_TEST_1_1_1,TA_1_1_1,...</span>
<span class="c1">#   201601010030,-20.4583,-1.8627,1.9019,0,5.5533,...</span>
<span class="c1">#   ...</span>
<span class="c1"># Assume that timestamps are the same as MuSICA output file</span>
<span class="k">def</span> <span class="nf">read_obs_nee</span><span class="p">(</span><span class="n">ofile</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ofile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fi</span><span class="p">:</span>
        <span class="n">head</span> <span class="o">=</span> <span class="n">fi</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">iivar</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;FC_1_1_1&#39;</span><span class="p">)</span>
    <span class="n">iiflag</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;FC_SSITC_TEST_1_1_1&#39;</span><span class="p">)</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">ofile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">nee</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dat</span><span class="p">[:,</span> <span class="n">iivar</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="p">(</span><span class="n">dat</span><span class="p">[:,</span> <span class="n">iiflag</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">nee</span>

<span class="c1"># RMSE is around 1-10 (umol m-2 s-1).</span>
<span class="c1"># Use a large random number in case of model error because of</span>
<span class="c1"># odd parameter combinations.</span>
<span class="k">def</span> <span class="nf">err</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span> <span class="o">*</span> <span class="mf">1000.</span>

<span class="c1">#</span>
<span class="c1"># Setup</span>
<span class="c1">#</span>

<span class="c1"># namelist files</span>
<span class="n">nfiles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;musica.nml&#39;</span><span class="p">,</span> <span class="s1">&#39;musica_soil.nml&#39;</span><span class="p">,</span> <span class="s1">&#39;fagus_sylvatica.nml&#39;</span><span class="p">]</span>
<span class="c1"># parameter names (not used, only for info)</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;GS_SLOPE&#39;</span><span class="p">,</span> <span class="s1">&#39;GS_HX_HALF&#39;</span><span class="p">,</span> <span class="s1">&#39;GS_HX_SHAPE&#39;</span><span class="p">]</span>
<span class="c1"># lower bounds</span>
<span class="n">lb</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">]</span>
<span class="c1"># upper bounds</span>
<span class="n">ub</span> <span class="o">=</span> <span class="p">[</span><span class="mf">13.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">20.</span><span class="p">]</span>

<span class="c1"># observations</span>
<span class="n">obsfile</span> <span class="o">=</span> <span class="s1">&#39;FR-Hes_europe-fluxdata_2017.txt&#39;</span>
<span class="n">obs</span> <span class="o">=</span> <span class="n">read_obs_nee</span><span class="p">(</span><span class="n">obsfile</span><span class="p">)</span>

<span class="c1"># Use a Python wrapper to run musica.exe, which deals with pid</span>
<span class="c1"># and works on all operating systems</span>
<span class="n">exe</span>             <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span> <span class="s1">&#39;run_musica.py&#39;</span><span class="p">]</span>
<span class="n">parameterfile</span>   <span class="o">=</span> <span class="n">nfiles</span>
<span class="n">parameterwriter</span> <span class="o">=</span> <span class="n">sub_params_ja</span>
<span class="n">outputfile</span>   <span class="o">=</span> <span class="s1">&#39;musica_out.nc&#39;</span>
<span class="n">outputreader</span> <span class="o">=</span> <span class="n">calc_rmse</span>
<span class="n">oargs</span>        <span class="o">=</span> <span class="p">[</span><span class="n">obs</span><span class="p">]</span>  <span class="c1"># additional outputreader arguments</span>
<span class="c1"># use exe_wrapper for run_musica.py</span>
<span class="n">wrap</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">exe</span><span class="p">,</span>
               <span class="n">parameterfile</span><span class="p">,</span> <span class="n">parameterwriter</span><span class="p">,</span>
               <span class="n">outputfile</span><span class="p">,</span> <span class="n">outputreader</span><span class="p">,</span>
               <span class="p">{</span><span class="s1">&#39;oargs&#39;</span><span class="p">:</span> <span class="n">oargs</span><span class="p">,</span>
                <span class="s1">&#39;pid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">err</span><span class="p">})</span>

<span class="c1">#</span>
<span class="c1"># Optimize</span>
<span class="c1">#</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Start optimization&#39;</span><span class="p">)</span>
<span class="n">ncpu</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">))</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">differential_evolution</span><span class="p">(</span><span class="n">wrap</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">ncpu</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Best parameters:&#39;</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39; with objective:&#39;</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">fun</span><span class="p">)</span>

<span class="c1"># write parameter files with optimized parameters and suffix .opt</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Write parameter files with optimized parameters&#39;</span><span class="p">)</span>
<span class="n">sub_params_ja</span><span class="p">(</span><span class="s1">&#39;fagus_sylvatica.nml&#39;</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="s1">&#39;opt&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Here we could have also used
<a class="reference internal" href="std_io.html#partialwrap.std_io.sub_params_names" title="partialwrap.std_io.sub_params_names"><code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_names()</span></code></a> instead of
<a class="reference internal" href="std_io.html#partialwrap.std_io.sub_params_ja" title="partialwrap.std_io.sub_params_ja"><code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_ja()</span></code></a> to replace the parameters in
the namelists. This would have changed the setup of <em>partial</em>
slightly to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">exe</span>             <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span> <span class="s1">&#39;run_musica.py&#39;</span><span class="p">]</span>
<span class="n">parameterfile</span>   <span class="o">=</span> <span class="n">nfiles</span>
<span class="n">parameterwriter</span> <span class="o">=</span> <span class="n">sub_params_names</span>
<span class="n">pargs</span>        <span class="o">=</span> <span class="p">[</span><span class="n">names</span><span class="p">]</span>  <span class="c1"># additional parameterwriter arguments</span>
<span class="n">outputfile</span>   <span class="o">=</span> <span class="s1">&#39;musica_out.nc&#39;</span>
<span class="n">outputreader</span> <span class="o">=</span> <span class="n">calc_rmse</span>
<span class="n">oargs</span>        <span class="o">=</span> <span class="p">[</span><span class="n">obs</span><span class="p">]</span>  <span class="c1"># additional outputreader arguments</span>
<span class="c1"># use exe_wrapper for run_musica.py</span>
<span class="n">wrap</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">exe</span><span class="p">,</span>
               <span class="n">parameterfile</span><span class="p">,</span> <span class="n">parameterwriter</span><span class="p">,</span>
               <span class="n">outputfile</span><span class="p">,</span> <span class="n">outputreader</span><span class="p">,</span>
               <span class="p">{</span><span class="s1">&#39;pargs&#39;</span><span class="p">:</span> <span class="n">pargs</span><span class="p">,</span> <span class="s1">&#39;oargs&#39;</span><span class="p">:</span> <span class="n">oargs</span><span class="p">,</span>
                <span class="s1">&#39;pid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">err</span><span class="p">})</span>
</pre></div>
</div>
<p>Only the <cite>parameterwriter</cite> changed and the <em>names</em> go into <cite>pargs</cite>,
additional arguments passed to the
<cite>parameterwriter = sub_params_names</cite>. We did not use it here because
<a class="reference external" href="https://ecofun.ispa.bordeaux.inrae.fr/index.php/musica-model/">MuSICA</a> can simulate several tree species in the same forest having
one namelist file per species with the same parameters,
e.g. <em>fagus_sylvatica.nml</em> and <em>picea_abeis.nml</em>.
<a class="reference internal" href="std_io.html#partialwrap.std_io.sub_params_names" title="partialwrap.std_io.sub_params_names"><code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_names()</span></code></a> would
replace the same value into both species files, while I can prepare
separate tags such as <em>#JA0000#</em> for <em>gs_slope</em> in
<em>fagus_sylvatica.nml</em> and <em>#JA0003#</em> for <em>gs_slope</em> in
<em>picea_abies.nml</em>.</p>
<p>We use almost the same Python wrapper as <cite>run_rastrigin.py</cite> in section
<a class="reference internal" href="#using-launch-scripts">Using launch scripts</a> to deal with <cite>pid</cite>. We only have to deal with
several parameter files instead of just one file here:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File: run_musica.py</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1"># get pid</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">exe</span>    <span class="o">=</span> <span class="s1">&#39;./musica.exe&#39;</span>
<span class="n">pfiles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;musica.nml&#39;</span><span class="p">,</span> <span class="s1">&#39;musica_soil.nml&#39;</span><span class="p">,</span> <span class="s1">&#39;fagus_sylvatica.nml&#39;</span><span class="p">]</span>
<span class="n">ofile</span>  <span class="o">=</span> <span class="s1">&#39;musica_out.nc&#39;</span>

<span class="c1"># make individual run directory</span>
<span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">rundir</span> <span class="o">=</span> <span class="s1">&#39;tmp&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">rundir</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;tmp.</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">rundir</span><span class="p">)</span>

<span class="c1"># copy individual parameter files</span>
<span class="k">for</span> <span class="n">pfile</span> <span class="ow">in</span> <span class="n">pfiles</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rundir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">pfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pfile</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rundir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">pfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># run in individual directory</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">exe</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rundir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">exe</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">rundir</span><span class="p">)</span>
<span class="n">err</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="n">exe</span><span class="p">],</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>

<span class="c1"># make output available to exe_wrapper</span>
<span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">ofile</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;../</span><span class="si">{</span><span class="n">ofile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">ofile</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;../</span><span class="si">{</span><span class="n">ofile</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># clean up</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">rundir</span><span class="p">)</span>
</pre></div>
</div>
<p>That’s all Folks!</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="index.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Quickstart</p>
      </div>
    </a>
    <a class="right-next"
       href="api.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Public API</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#external-executables">External executables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#masked-parameters">Masked parameters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-arguments">Additional arguments</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parallel-evaluation">Parallel evaluation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-launch-scripts">Using launch scripts</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#input-output-functions">Input/Output functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#python-functions">Python functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-real-life-example">A real life example</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Matthias Cuntz
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2016-2023, Matthias Cuntz.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=ac02cc09edc035673794"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>