<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>User Guide &#8212; partialwrap 1.7 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="_static/css/custom.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Public API" href="api.html" />
    <link rel="prev" title="Quickstart" href="index.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="user-guide">
<h1>User Guide<a class="headerlink" href="#user-guide" title="Permalink to this heading">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">partialwrap</span></code> provides wrappers for external executables and Python functions so that they can
easily be partialised with Python’s <a class="reference external" href="https://docs.python.org/3/library/functools.html#functools.partial" title="(in Python v3.11)"><code class="xref py py-func docutils literal notranslate"><span class="pre">functools.partial()</span></code></a>.</p>
<p>Partial’s ingenious mechanism allows to use even very complex functions with many arguments and
keyword arguments with routines that need functions in the simple form <cite>func(x)</cite>. This includes
Python’s <a class="reference external" href="https://docs.python.org/3/library/functions.html#map" title="(in Python v3.11)"><code class="xref py py-func docutils literal notranslate"><span class="pre">map()</span></code></a> function, the minimizers in <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/optimize.html#module-scipy.optimize" title="(in SciPy v1.11.2)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">scipy.optimize</span></code></a>, and plenty of third-party
modules such as <code class="xref py py-mod docutils literal notranslate"><span class="pre">emcee</span></code> or <a class="reference external" href="https://pyeee.readthedocs.io/en/latest/package.html#module-pyeee" title="(in pyeee v3.0)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyeee</span></code></a>. It also allows easy parallelization of code with, for
example, the parallel <code class="xref py py-func docutils literal notranslate"><span class="pre">map()</span></code> function of the <a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html#module-multiprocessing" title="(in Python v3.11)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">multiprocessing</span></code></a>
module or via the Message Passing Interface (MPI) <a class="reference external" href="https://mpi4py.readthedocs.io/en/latest/mpi4py.html#module-mpi4py" title="(in MPI for Python v4.0.0)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mpi4py</span></code></a>.</p>
<p><code class="docutils literal notranslate"><span class="pre">partialwrap</span></code> provides two easy wrappers so that <a class="reference external" href="https://docs.python.org/3/library/functools.html#functools.partial" title="(in Python v3.11)"><code class="xref py py-func docutils literal notranslate"><span class="pre">functools.partial()</span></code></a> can be used with
external programs as well as Python functions. It provides further functions to deal with
input/output external programs. The user guide gives examples how to use pretty much every external
program within Python modules.</p>
<section id="simple-python-functions">
<h2>Simple Python functions<a class="headerlink" href="#simple-python-functions" title="Permalink to this heading">¶</a></h2>
<p>The easiest wrapper in <code class="docutils literal notranslate"><span class="pre">partialwrap</span></code> is for Python functions.</p>
<p>Consider the <em>Rastrigin function</em> (<a class="reference external" href="https://en.wikipedia.org/wiki/Rastrigin_function">https://en.wikipedia.org/wiki/Rastrigin_function</a>), which is a
popular function for performance testing of optimization algorithms: <span class="math notranslate nohighlight">\(y = a \cdot n +
\sum_i^n (x_i^2 - a \cos(b \cdot x_i))\)</span>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">def</span> <span class="nf">rastrigin</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
<p>The Rastrigin function has a global minimum of <span class="math notranslate nohighlight">\(0\)</span> at all <span class="math notranslate nohighlight">\(x_i = 0\)</span>. <span class="math notranslate nohighlight">\(a\)</span> influences
mainly the depths of the (local and global) minima, whereas <span class="math notranslate nohighlight">\(b\)</span> influences mainly the size of
the minima.</p>
<p>A common form uses <span class="math notranslate nohighlight">\(a = 10\)</span> and <span class="math notranslate nohighlight">\(b = 2 \pi\)</span>. The parameters <span class="math notranslate nohighlight">\(x_i\)</span> should then be
in the interval <span class="math notranslate nohighlight">\([-5.12,5.12]\)</span>.</p>
<p>The 5-dimensional Rastrigin function is hence called in Python as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ndim</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">a</span>    <span class="o">=</span> <span class="mf">10.</span>
<span class="n">xmin</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.12</span>
<span class="n">xmax</span> <span class="o">=</span>  <span class="mf">5.12</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">xmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="n">ndim</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">rastrigin</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
<p>One can search the global minimum of the Rastrigin function using, for example, the differential
evolution algorithm of the <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/optimize.html#module-scipy.optimize" title="(in SciPy v1.11.2)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">scipy.optimize</span></code></a> package:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">opt</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">differential_evolution</span><span class="p">(</span><span class="n">rastrigin</span><span class="p">,</span> <span class="p">[(</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">),]</span><span class="o">*</span><span class="n">ndim</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="p">]))</span>
</pre></div>
</div>
<p><a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/optimize.html#module-scipy.optimize" title="(in SciPy v1.11.2)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">scipy.optimize</span></code></a> does not allow to pass keyword arguments to the function. It is hence <em>a
priori</em> not possible to search the minimum of the Rastrigin function with another <span class="math notranslate nohighlight">\(b\)</span>
parameter. (This is an illustrative example while it is, of course, possible to just pass <cite>b</cite> as a
second argument in this case.)</p>
<p>In this case, one can use Python’s <a class="reference external" href="https://docs.python.org/3/library/functools.html#functools.partial" title="(in Python v3.11)"><code class="xref py py-func docutils literal notranslate"><span class="pre">functools.partial()</span></code></a> function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="c1"># helper function</span>
<span class="k">def</span> <span class="nf">call_func_arg_kwarg</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>

<span class="c1"># Partialise function with fixed parameters</span>
<span class="n">a</span> <span class="o">=</span> <span class="mf">5.</span>
<span class="n">b</span> <span class="o">=</span> <span class="mf">4.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">partial_rastrigin</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">call_func_arg_kwarg</span><span class="p">,</span> <span class="n">rastrigin</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="c1"># search minimum</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">differential_evolution</span><span class="p">(</span><span class="n">partial_rastrigin</span><span class="p">,</span> <span class="p">[(</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">),]</span><span class="o">*</span><span class="n">ndim</span><span class="p">)</span>
</pre></div>
</div>
<p>Figuratively speaking, <a class="reference external" href="https://docs.python.org/3/library/functools.html#functools.partial" title="(in Python v3.11)"><code class="xref py py-func docutils literal notranslate"><span class="pre">partial()</span></code></a> passes <span class="math notranslate nohighlight">\(a\)</span> and <span class="math notranslate nohighlight">\(b\)</span> already during definition
to the function <cite>call_func_arg_kwarg</cite>. <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html#scipy.optimize.minimize" title="(in SciPy v1.11.2)"><code class="xref py py-func docutils literal notranslate"><span class="pre">minimize()</span></code></a> can then simply call it as
<cite>partial_rastrigin(x)</cite>, which finalizes the call to <cite>rastrigin(x, a, b=b)</cite>.</p>
<p><code class="docutils literal notranslate"><span class="pre">partialwrap</span></code> provides a convenience function <code class="xref py py-func docutils literal notranslate"><span class="pre">function_wrapper()</span></code> that
generalises the above helper function <cite>call_func_arg_kwarg</cite> by passing all arguments, given as a
<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#list" title="(in Python v3.11)"><code class="xref any docutils literal notranslate"><span class="pre">list</span></code></a>, and keyword arguments, given as a <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.11)"><code class="xref any docutils literal notranslate"><span class="pre">dict</span></code></a>, to arbitrary functions by the usual
<cite>*args</cite>, <cite>**kwargs</cite> mechanism:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">function_wrapper</span>

<span class="n">args</span>   <span class="o">=</span> <span class="p">[</span><span class="mf">20.</span><span class="p">]</span>
<span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">}</span>
<span class="n">rastra</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">function_wrapper</span><span class="p">,</span> <span class="n">rastrigin</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
<span class="n">res</span>    <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">differential_evolution</span><span class="p">(</span><span class="n">rastra</span><span class="p">,</span> <span class="p">[(</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">),]</span><span class="o">*</span><span class="n">ndim</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that you pass <cite>args</cite> and <cite>kwargs</cite> and not <cite>*args</cite> and <cite>**kwargs</cite> to <a class="reference external" href="https://docs.python.org/3/library/functools.html#functools.partial" title="(in Python v3.11)"><code class="xref py py-func docutils literal notranslate"><span class="pre">partial()</span></code></a>.
The wrapper is simply coded as the following and given for convenience:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">function_wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">kwarg</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwarg</span><span class="p">)</span>
</pre></div>
</div>
<p>Another example where partialisation might come in handy is the use of several CPUs to speed up
multiple evaluations of slow function evaluations. Parallelisation always has on overhead but it
will be beneficial in case of more expensive models, which is most often true for real research
problems. One can use the <code class="xref py py-func docutils literal notranslate"><span class="pre">map()</span></code> function of Python’s
<a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html#module-multiprocessing" title="(in Python v3.11)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">multiprocessing</span></code></a> module. I have 4 processors and can hence evaluate the function 4 times
simultaneously:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>

<span class="n">neval</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">xmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random_sample</span><span class="p">((</span><span class="n">neval</span><span class="p">,</span><span class="n">ndim</span><span class="p">))</span>
<span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">rastra</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
<p>Note that all programming guidelines of the <a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html#module-multiprocessing" title="(in Python v3.11)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">multiprocessing</span></code></a> module apply
(<a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html#programming-guidelines">https://docs.python.org/3/library/multiprocessing.html#programming-guidelines</a>), which might
provide some “gotchas” if multiprocessing is throwing, for example, <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#RuntimeError" title="(in Python v3.11)"><code class="xref any docutils literal notranslate"><span class="pre">RuntimeError</span></code></a> or
<a class="reference external" href="https://docs.python.org/3/library/exceptions.html#AttributeError" title="(in Python v3.11)"><code class="xref any docutils literal notranslate"><span class="pre">AttributeError</span></code></a>.</p>
</section>
<section id="masked-parameters-in-python-functions">
<h2>Masked parameters in Python functions<a class="headerlink" href="#masked-parameters-in-python-functions" title="Permalink to this heading">¶</a></h2>
<p>A common case in numerical optimization is the exclusion of some well-known parameters from
optimization, or fixing correlated parameters during optimization. But the numerical model still
needs to get a parameter value for the excluded/fixed parameters during optimization.
<code class="docutils literal notranslate"><span class="pre">partialwrap</span></code> provides a convenience function <code class="xref py py-func docutils literal notranslate"><span class="pre">function_mask_wrapper()</span></code> to
include only the masked parameters in the function evaluation and take default values where
<cite>mask==False</cite>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">function_mask_wrapper</span>

<span class="n">x0</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
<span class="c1"># Do not optimize the second parameter but take its initial value 0.0001</span>
<span class="n">mask</span>    <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
<span class="n">mrastra</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">function_mask_wrapper</span><span class="p">,</span> <span class="n">rastrigin</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

<span class="n">res</span>        <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">differential_evolution</span><span class="p">(</span><span class="n">mrastra</span><span class="p">,</span> <span class="p">[(</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">),]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
<span class="n">xout</span>       <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">xout</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
</pre></div>
</div>
<p>The values of <cite>x0</cite> will be taken where <cite>mask==False</cite>, i.e. <cite>mask</cite> could be called an include-mask.</p>
<p>The wrapper is very similar to <code class="xref py py-func docutils literal notranslate"><span class="pre">function_wrapper()</span></code> in that it passes <cite>args</cite> and
<cite>kwargs</cite> to the function, but further needs the default values <cite>x0</cite> and the <cite>mask</cite> as inputs. The
wrapper is simply coded as the following and given for convenience:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">function_mask_wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">kwarg</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">xx</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="n">xx</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwarg</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="external-executables">
<h2>External executables<a class="headerlink" href="#external-executables" title="Permalink to this heading">¶</a></h2>
<p>The great power of <code class="docutils literal notranslate"><span class="pre">partialwrap</span></code> is its ability to wrap external executables that cannot directly
be called from Python via <code class="xref py py-mod docutils literal notranslate"><span class="pre">Cython</span></code> or <a class="reference external" href="https://numpy.org/doc/stable/f2py/usage.html#module-numpy.f2py" title="(in NumPy v1.26)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">numpy.f2py</span></code></a> or similar.</p>
<p><code class="docutils literal notranslate"><span class="pre">partialwrap</span></code> provides two wrapper functions to work with external executables:
<code class="xref py py-func docutils literal notranslate"><span class="pre">partialwrap.exe_wrapper()</span></code> and <code class="xref py py-func docutils literal notranslate"><span class="pre">partialwrap.exe_mask_wrapper()</span></code>. The two wrappers
basically launch the external executable <cite>exe</cite> using Python’s <a class="reference external" href="https://docs.python.org/3/library/subprocess.html#module-subprocess" title="(in Python v3.11)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">subprocess</span></code></a> module, while
providing functionality to read and write parameter values and model output. The wrappers write a
parameter set into file(s) <cite>parameterfile</cite> that can be read by the external program <cite>exe</cite>. The
external program <cite>exe</cite> should write its result(s) to (a) file(s) <cite>outputfile</cite>, which will then be
read by the wrappers in return. This means that the two wrappers need to know a function
<cite>parameterwriter</cite> that writes the parameters in the file(s) <cite>parameterfile</cite> suitable for the
external model <cite>exe</cite>. The wrappers also need to know a function <cite>outputreader</cite> that reads the model
output(s) from the file(s) <cite>outputfile</cite>, and possibly calculating an objective value or just
passing back the output value(s).</p>
<p>Consider for simplicity an external Python program (e.g. <cite>rastrigin1.py</cite>)
that calculates the Rastrigin function with <span class="math notranslate nohighlight">\(a = 10\)</span> and <span class="math notranslate nohighlight">\(b = 2 \pi\)</span>,
reading in an arbitrary number of parameters <span class="math notranslate nohighlight">\(x_i\)</span> from a
<cite>parameterfile = params.txt</cite> and writing its output into an
<cite>outputfile = out.txt</cite>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File: rastrigin1.py</span>

<span class="c1"># Rastrigin function a=10, b=2*pi</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">def</span> <span class="nf">rastrigin1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">10.</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">10.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>

<span class="c1"># read parameters</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">standard_parameter_reader</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">standard_parameter_reader</span><span class="p">(</span><span class="s1">&#39;params.txt&#39;</span><span class="p">)</span>

<span class="c1"># calc function</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">rastrigin1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># write output file</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;out.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">ff</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="xref py py-func docutils literal notranslate"><span class="pre">partialwrap.standard_parameter_reader()</span></code> is a convenience functions that reads one parameter
per line from a file without a header.</p>
<p>The external program, which is in full <cite>python3 rastrigin1.py</cite>, can be used with the wrapper
function <code class="xref py py-func docutils literal notranslate"><span class="pre">partialwrap.exe_wrapper()</span></code> of <code class="docutils literal notranslate"><span class="pre">partialwrap</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">standard_parameter_writer</span><span class="p">,</span> <span class="n">standard_output_reader</span>

<span class="n">rastrigin_exe</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span> <span class="s1">&#39;rastrigin1.py&#39;</span><span class="p">]</span>
<span class="n">parameterfile</span>  <span class="o">=</span> <span class="s1">&#39;params.txt&#39;</span>
<span class="n">outputfile</span>     <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span>
<span class="n">rastrigin_wrap</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">rastrigin_exe</span><span class="p">,</span>
                         <span class="n">parameterfile</span><span class="p">,</span> <span class="n">standard_parameter_writer</span><span class="p">,</span>
                         <span class="n">outputfile</span><span class="p">,</span> <span class="n">standard_output_reader</span><span class="p">,</span> <span class="p">{})</span>
<span class="n">x0</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">rastrigin_wrap</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;BFGS&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="xref py py-func docutils literal notranslate"><span class="pre">partialwrap.standard_parameter_writer()</span></code> is another convenience function that writes one
parameter per line in a file without a header. The function
<code class="xref py py-func docutils literal notranslate"><span class="pre">partialwrap.standard_output_reader()</span></code> simply reads one value from a file without a header. The
empty dictionary at the end of the partial statement is explained below.</p>
<p>Here I changed from the Differential Evolution algorithm to the quasi-Newton method of Broyden,
Fletcher, Goldfarb, and Shanno (BFGS). Differential Evolution finds the minimum of the Rastrigin
function much better than the gradient-based methods of <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html#scipy.optimize.minimize" title="(in SciPy v1.11.2)"><code class="xref py py-func docutils literal notranslate"><span class="pre">scipy.optimize.minimize()</span></code></a> but needs
much more function evaluations. It needs more that 2000 function evaluations for the
two-dimensional Rastrigin function, while BFGS stops after about 40-50 function evaluations with
the given good initial value. Calling the subprocess <cite>python3 rastrigin1.py</cite> needs about 180 ms on
my machine. The wrapper adds about another 50 ms for writing parameters, reading output, etc.,
so that the above example takes more than 9 minutes to finish with Differential
Evolution and about 7 seconds with BFGS.</p>
<p>One can see that the external Rastrigin program could have been written in C or Fortran or similar,
compiled, and then used with the <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/optimize.html#module-scipy.optimize" title="(in SciPy v1.11.2)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">scipy.optimize</span></code></a> algorithms in Python. A Fortran program
could look like this:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">program </span><span class="n">rastrigin1</span>

<span class="w">    </span><span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">kind</span><span class="p">(</span><span class="mf">1.0d0</span><span class="p">)</span>

<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">pi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.141592653589793238462643383279502884197_dp</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="mf">0.0_dp</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0_dp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pi</span>

<span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">pfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;params.txt&#39;</span>
<span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ofile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;out.txt&#39;</span>

<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">punit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ounit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">101</span>

<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="c">! parameters, up to 100 dimensions</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">out</span><span class="w">               </span><span class="c">! output value</span>
<span class="w">    </span><span class="kt">integer</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span><span class="w">                 </span><span class="c">! number of dimensions</span>

<span class="w">    </span><span class="kt">integer</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">ios</span>

<span class="w">    </span><span class="c">! read parameters</span>
<span class="w">    </span><span class="k">open</span><span class="p">(</span><span class="n">punit</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="n">pfile</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;old&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;read&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="n">ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">n</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">do while</span><span class="w"> </span><span class="p">(</span><span class="n">ios</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">read</span><span class="p">(</span><span class="n">punit</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">=*</span><span class="p">,</span><span class="w"> </span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="w">        </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">end do</span>
<span class="k">    </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="k">close</span><span class="p">(</span><span class="n">punit</span><span class="p">)</span>

<span class="w">    </span><span class="c">! calc function</span>
<span class="w">    </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kt">real</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">dp</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">a</span><span class="o">*</span><span class="nb">cos</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">x</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="p">)))</span>

<span class="w">    </span><span class="c">! write output file</span>
<span class="w">    </span><span class="k">open</span><span class="p">(</span><span class="n">ounit</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="n">ofile</span><span class="p">)</span>
<span class="w">    </span><span class="k">write</span><span class="p">(</span><span class="n">ounit</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">out</span>
<span class="w">    </span><span class="k">close</span><span class="p">(</span><span class="n">ounit</span><span class="p">)</span>

<span class="k">end program </span><span class="n">rastrigin1</span>
</pre></div>
</div>
<p>This program can be compiled like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gfortran<span class="w"> </span>-O3<span class="w"> </span>-o<span class="w"> </span>rastrigin1.exe<span class="w"> </span>rastrigin1.f90
</pre></div>
</div>
<p>and called in Python:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rastrigin_f90exe</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;./rastrigin1.exe&#39;</span><span class="p">]</span>
<span class="n">rastrigin_f90wrap</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">rastrigin_f90exe</span><span class="p">,</span>
                            <span class="n">parameterfile</span><span class="p">,</span> <span class="n">standard_parameter_writer</span><span class="p">,</span>
                            <span class="n">outputfile</span><span class="p">,</span> <span class="n">standard_output_reader</span><span class="p">,</span> <span class="p">{})</span>
<span class="n">x0</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">rastrigin_f90wrap</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;BFGS&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The compiled Fortran needs about 5 ms when run in a <a class="reference external" href="https://docs.python.org/3/library/subprocess.html#module-subprocess" title="(in Python v3.11)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">subprocess</span></code></a>, which is about one tenth of
the overhead of the wrapper function <code class="xref py py-func docutils literal notranslate"><span class="pre">partialwrap.exe_wrapper()</span></code>. Very fast executables can
hence be minimized in several seconds using <code class="docutils literal notranslate"><span class="pre">partialwrap</span></code> (about 4 seconds in the case of the
two-dimensional Rastrigin function) and the gradient-based methods of <a class="reference external" href="https://docs.scipy.org/doc/scipy/index.html#module-scipy" title="(in SciPy v1.11.2)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">scipy</span></code></a>, or in several
minutes with global search algorithms such as Differential Evolution (1.5 minutes in case of the
two-dimensional Rastrigin function).</p>
</section>
<section id="masked-parameters-with-external-executables">
<h2>Masked parameters with external executables<a class="headerlink" href="#masked-parameters-with-external-executables" title="Permalink to this heading">¶</a></h2>
<p>Excluding parameters from, for example, optimization works exactly the same as for Python
functions. One passes the same arguments to <code class="xref py py-func docutils literal notranslate"><span class="pre">partialwrap.exe_mask_wrapper()</span></code> than to
<code class="xref py py-func docutils literal notranslate"><span class="pre">partialwrap.exe_wrapper()</span></code> plus the default values <cite>x0</cite> and the <cite>mask</cite>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">exe_mask_wrapper</span>

<span class="n">rastrigin_f90exe</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;./rastrigin1.exe&#39;</span><span class="p">]</span>
<span class="n">x0</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
<span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
<span class="n">mrastrigin_f90wrap</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">exe_mask_wrapper</span><span class="p">,</span> <span class="n">rastrigin_f90exe</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span>
                             <span class="n">parameterfile</span><span class="p">,</span> <span class="n">standard_parameter_writer</span><span class="p">,</span>
                             <span class="n">outputfile</span><span class="p">,</span> <span class="n">standard_output_reader</span><span class="p">,</span> <span class="p">{})</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">mrastrigin_f90wrap</span><span class="p">,</span> <span class="n">x0</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;BFGS&#39;</span><span class="p">)</span>
<span class="n">xout</span>       <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">xout</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
</pre></div>
</div>
<p><code class="xref py py-func docutils literal notranslate"><span class="pre">partialwrap.exe_mask_wrapper()</span></code> basically does the transformation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">xx</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
<span class="n">xx</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
</pre></div>
</div>
<p>and then calls <code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code> with <cite>xx</cite> (instead of <cite>x</cite>). So everything written
in the following about <code class="xref py py-func docutils literal notranslate"><span class="pre">partialwrap.exe_wrapper()</span></code> is also valid for
<code class="xref py py-func docutils literal notranslate"><span class="pre">partialwrap.exe_mask_wrapper()</span></code>.</p>
</section>
<section id="additional-arguments-for-exe-wrapper">
<h2>Additional arguments for exe_wrapper<a class="headerlink" href="#additional-arguments-for-exe-wrapper" title="Permalink to this heading">¶</a></h2>
<p>The user can pass further arguments to <code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code> via a dictionary at the end
of the call, which was empty at the examples above.</p>
<p>If you need to access shell features such as pipes, wildcards, environment variables, etc., the
external executable <cite>exe</cite> can be called in a shell. Setting the key <cite>shell</cite> to <cite>True</cite> passes
<cite>shell=True</cite> to <a class="reference external" href="https://docs.python.org/3/library/subprocess.html#subprocess.check_output" title="(in Python v3.11)"><code class="xref py py-func docutils literal notranslate"><span class="pre">subprocess.check_output()</span></code></a>, executing the external executable <cite>exe</cite> in a
shell. Note that the <cite>exe</cite> name in <a class="reference external" href="https://docs.python.org/3/library/subprocess.html#module-subprocess" title="(in Python v3.11)"><code class="xref any docutils literal notranslate"><span class="pre">subprocess</span></code></a> must be a string if <cite>shell=True</cite> and a
sequence if <cite>shell=False</cite>. Setting the key <cite>debug</cite> to <cite>True</cite> uses <a class="reference external" href="https://docs.python.org/3/library/subprocess.html#subprocess.check_call" title="(in Python v3.11)"><code class="xref py py-func docutils literal notranslate"><span class="pre">subprocess.check_call()</span></code></a>
instead of <a class="reference external" href="https://docs.python.org/3/library/subprocess.html#subprocess.check_output" title="(in Python v3.11)"><code class="xref py py-func docutils literal notranslate"><span class="pre">subprocess.check_output()</span></code></a> so that any output of the external executable will be
written to the screen (precisely <a class="reference external" href="https://docs.python.org/3/library/subprocess.html#subprocess.STDOUT" title="(in Python v3.11)"><code class="xref any docutils literal notranslate"><span class="pre">subprocess.STDOUT</span></code></a>). This especially prints out also any
errors that might occur during execution. The above example using the external python program
<cite>rastrigin1.py</cite> can be debugged as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">standard_parameter_writer</span><span class="p">,</span> <span class="n">standard_output_reader</span>

<span class="n">rastrigin_exe</span>  <span class="o">=</span> <span class="s1">&#39;python3 rastrigin1.py&#39;</span>
<span class="n">parameterfile</span>  <span class="o">=</span> <span class="s1">&#39;params.txt&#39;</span>
<span class="n">outputfile</span>     <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span>
<span class="n">rastrigin_wrap</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">rastrigin_exe</span><span class="p">,</span>
                         <span class="n">parameterfile</span><span class="p">,</span> <span class="n">standard_parameter_writer</span><span class="p">,</span>
                         <span class="n">outputfile</span><span class="p">,</span> <span class="n">standard_output_reader</span><span class="p">,</span>
                         <span class="p">{</span><span class="s1">&#39;shell&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">})</span>
<span class="n">x0</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">rastrigin_wrap</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;BFGS&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Note the change of <cite>rastrigin_exe = [‘python3’, ‘rastrigin1.py’]</cite> to <cite>rastrigin_exe = ‘python3
rastrigin1.py’</cite> due to the use of <cite>shell=True</cite>.</p>
<p>Both, <cite>parameterfile</cite> and <cite>outputfile</cite> can either be single filenames (string) or a list of
filenames, which will be passed to <cite>parameterwriter</cite> and <cite>outputreader</cite>, respectively.
<code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code> deletes the parameter and output files after use. If you want to
keep the files, you can set the keys <cite>keepparameterfile</cite> and <cite>keepoutputfile</cite> to <cite>True</cite>. This can
be useful, for example, if your <cite>parameterwriter</cite> just changes a parameterfile in-place. An example
of such a <cite>parameterwriter</cite> is <code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_names()</span></code>, which
substitutes all lines <cite>name=.*</cite> with <cite>name=parameter</cite> in the input files. The input file might be a
<cite>parameterfile</cite> for the external executable <cite>exe</cite>, where a parameter is given as
<cite>parameter_name=parameter_value</cite>, for example a Fortran namelist or a file in Python’s standard
<a class="reference external" href="https://docs.python.org/3/library/configparser.html#module-configparser" title="(in Python v3.11)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">configparser</span></code></a> format. If the first iteration of, for example, an optimization removed the
file, the next iteration could not use it again to insert the new parameter set. The
parameterwriter <code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_names()</span></code> not only needs the filename(s)
<cite>parameterfile</cite> and the parameter values <cite>params</cite> as input as the above
<code class="xref py py-func docutils literal notranslate"><span class="pre">standard_parameter_writer(parameterfile,</span> <span class="pre">params)()</span></code> but also the <cite>names</cite> of the parameters. One can
pass additionally arguments <cite>pargs</cite> and keyword arguments <cite>pkwargs</cite> to the <cite>parameterwriter</cite> by
passing the dictionary entries <cite>‘pargs’:parameterwriter_arguments</cite> and
<cite>‘pkwargs’:parameterwriter_keywords</cite> to <code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code>.</p>
<p>Let’s change the above external Python program <cite>rastrigin1.py</cite>, calling it <cite>rastrigin2.py</cite>, so that
it reads its parameters from an input file of the form <cite>name = parameter</cite>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># File: params.txt
  param01 = 0.1 ! Fortran comment
param03   = 0.3 # Python comment
 param02 = 0.2  // C comment
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File: rastrigin2.py</span>

<span class="c1"># Rastrigin function a=10, b=2*pi</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">def</span> <span class="nf">rastrigin1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">10.</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">10.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>

<span class="c1"># read parameters</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;params.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fi</span><span class="p">:</span>
    <span class="n">pdict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fi</span><span class="p">:</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span> <span class="k">continue</span>
        <span class="n">pdict</span><span class="p">[</span><span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">pdict</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pdict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="p">])</span>

<span class="c1"># calc function</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">rastrigin1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># write output file</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;out.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">ff</span><span class="p">)</span>
</pre></div>
</div>
<p>The parameterwriter <code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_names()</span></code> will take the
<cite>parameterfile=’params.txt’</cite>, searches for the lines that have nothing but whitespace before the
<cite>names=[‘param01’,’param02’,’param03’] and replaces the lines with `names[i] = params[i]</cite>.
<cite>params.txt</cite> will be reused for each iteration during optimization so should not be deleted by
<code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">sub_params_names</span><span class="p">,</span> <span class="n">standard_output_reader</span>

<span class="n">rastrigin_exe</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span> <span class="s1">&#39;rastrigin2.py&#39;</span><span class="p">]</span>
<span class="n">parameterfile</span>  <span class="o">=</span> <span class="s1">&#39;params.txt&#39;</span>
<span class="n">outputfile</span>     <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span>
<span class="n">x0</span>    <span class="o">=</span> <span class="p">[</span> <span class="mf">0.1</span><span class="p">,</span>       <span class="mf">0.2</span><span class="p">,</span>       <span class="mf">0.5</span><span class="p">]</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;param01&#39;</span><span class="p">,</span> <span class="s1">&#39;param02&#39;</span><span class="p">,</span> <span class="s1">&#39;param03&#39;</span><span class="p">]</span>
<span class="n">rastrigin_wrap</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">rastrigin_exe</span><span class="p">,</span>
                         <span class="n">parameterfile</span><span class="p">,</span> <span class="n">sub_params_names</span><span class="p">,</span>
                         <span class="n">outputfile</span><span class="p">,</span> <span class="n">standard_output_reader</span><span class="p">,</span>
                         <span class="p">{</span><span class="s1">&#39;pargs&#39;</span><span class="p">:[</span><span class="n">names</span><span class="p">],</span> <span class="s1">&#39;keepparameterfile&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">})</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">rastrigin_wrap</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;BFGS&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Note the list in <cite>‘pargs’:[names]</cite>. If one put <cite>‘pargs’:names</cite> than the <cite>*args</cite> mechanism would pass
three single arguments to <cite>sub_params_names</cite>, which would hence wrongly receive 5 instead of 3 arguments.</p>
<p>The same <cite>*args/**kwargs</cite> mechanism is implemented for the <cite>outputreader</cite>, where one can set the
keys <cite>oargs</cite> and <cite>okwargs</cite> to be passed to <cite>outputreader</cite>. This can be used, for example, to pass
observational data and uncertainty to calculate an evaluation metric such as a log-likelihood from
model output.</p>
</section>
<section id="provided-parameterwriter-and-outputreader">
<h2>Provided parameterwriter and outputreader<a class="headerlink" href="#provided-parameterwriter-and-outputreader" title="Permalink to this heading">¶</a></h2>
<p><cite>partialwrap</cite> comes with a few predefined <cite>parameterwriter</cite> and <cite>outputreader</cite>. The most basic ones
were used in the examples above. <code class="xref py py-func docutils literal notranslate"><span class="pre">standard_parameter_writer()</span></code> simply writes
parameter values one by one in a file. <code class="xref py py-func docutils literal notranslate"><span class="pre">standard_parameter_reader()</span></code> reads
parameters line by line from a file that does not contain any header lines, comments or similar.
<code class="xref py py-func docutils literal notranslate"><span class="pre">standard_output_reader()</span></code> similarly reads a single value from a file.</p>
<p><code class="xref py py-func docutils literal notranslate"><span class="pre">standard_parameter_writer_bounds_mask()</span></code> writes another common format, which
includes one header line (# value min max mask) plus one line per parameter with the following
columns: consecutive parameter number, current parameter value, lower bound of parameter, upper
bound of parameter, 0/1 mask. <code class="xref py py-func docutils literal notranslate"><span class="pre">standard_parameter_reader_bounds_mask()</span></code> reads
exactly these kind of files (lines starting with ‘#’ will be ignored). A last example of an
<cite>outputreader</cite> is <code class="xref py py-func docutils literal notranslate"><span class="pre">standard_timeseries_reader()</span></code> (or
<code class="xref py py-func docutils literal notranslate"><span class="pre">standard_time_series_reader()</span></code>), which reads all lines from an output file into a
<cite>numpy.ndarray</cite>.</p>
<p>These <cite>parameterwriter</cite> and <cite>outputreader</cite> are given rather as examples for users to write their
own readers and writers.</p>
<p>A versatile <cite>parameterwriter</cite> ready to use is, however, <code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_names()</span></code>,
which was used in the example above. It searches the <cite>parameterfile</cite> for lines that have nothing
but whitespace before given <cite>names</cite> and replaces the right hand side of the equal sign with the
parameter value. This can be used with a large variety of parameter files such as Python’s
<a class="reference external" href="https://docs.python.org/3/library/configparser.html#module-configparser" title="(in Python v3.11)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">configparser</span></code></a> files or Fortran namelists or similar. It exists in two variants: <cite>names</cite> are
case-sensitive in <code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_names_case()</span></code> and case-insensitive in
<code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_names_ignorecase()</span></code>. <code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_names()</span></code> is simply a
wrapper for the latter case-insensitive function.</p>
<p>Another versatile <cite>parameterwriter</cite> that comes with <cite>partialwrap</cite> is
<code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_ja()</span></code>. It searches for the strings #JA0000#, #JA0001#, … in the
<cite>parameterfile</cite> and replaces them with the values of the first parameter, the second parameter, and
so on. The file must be well prepared in advance but the parameters can then be anywhere in the
<cite>parameterfile</cite>, appear several times on the same line or on different lines, etc. After
<code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_ja()</span></code> was called once, for example by an optimization routine, the
tags #JA0000#, #JA0001#, … would be gone and a second iteration could not fill in new parameter
values. The best way to use <code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_ja()</span></code> is thus with the key <cite>‘pid’:True</cite> to
<code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code>, which will be explained in the next section about concurrent
execution of the external program.</p>
</section>
<section id="parallel-evaluation-of-external-executables">
<h2>Parallel evaluation of external executables<a class="headerlink" href="#parallel-evaluation-of-external-executables" title="Permalink to this heading">¶</a></h2>
<p>Most real-life numerical models have longer run times than just a few milliseconds. One might
hence like to take advantage of more processing units such as simple multi-core processors,
multi-processor nodes or computer clusters. Take the simple parallel evaluation of the Rastrigin
function from above:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">function_wrapper</span>

<span class="n">args</span>   <span class="o">=</span> <span class="p">[</span><span class="mf">10.</span><span class="p">]</span>
<span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">}</span>
<span class="n">rastra</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">function_wrapper</span><span class="p">,</span> <span class="n">rastrigin</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

<span class="n">ndim</span>  <span class="o">=</span> <span class="mi">2</span>
<span class="n">xmin</span>  <span class="o">=</span> <span class="o">-</span><span class="mf">5.12</span>
<span class="n">xmax</span>  <span class="o">=</span>  <span class="mf">5.12</span>
<span class="n">neval</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">xmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random_sample</span><span class="p">((</span><span class="n">neval</span><span class="p">,</span><span class="n">ndim</span><span class="p">))</span>
<span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">rastra</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
<p>If we want to use the external program <cite>rastrigin1.py</cite> instead of the Python function
<code class="xref py py-func docutils literal notranslate"><span class="pre">rastrigin()</span></code>, one would naively do:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">standard_parameter_writer</span><span class="p">,</span> <span class="n">standard_output_reader</span>

<span class="n">rastrigin_exe</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span> <span class="s1">&#39;rastrigin1.py&#39;</span><span class="p">]</span>
<span class="n">parameterfile</span>  <span class="o">=</span> <span class="s1">&#39;params.txt&#39;</span>
<span class="n">outputfile</span>     <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span>
<span class="n">rastrigin_wrap</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">rastrigin_exe</span><span class="p">,</span>
                         <span class="n">parameterfile</span><span class="p">,</span> <span class="n">standard_parameter_writer</span><span class="p">,</span>
                         <span class="n">outputfile</span><span class="p">,</span> <span class="n">standard_output_reader</span><span class="p">,</span> <span class="p">{})</span>
<span class="n">ndim</span>  <span class="o">=</span> <span class="mi">2</span>
<span class="n">xmin</span>  <span class="o">=</span> <span class="o">-</span><span class="mf">5.12</span>
<span class="n">xmax</span>  <span class="o">=</span>  <span class="mf">5.12</span>
<span class="n">neval</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">xmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random_sample</span><span class="p">((</span><span class="n">neval</span><span class="p">,</span><span class="n">ndim</span><span class="p">))</span>
<span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">rastrigin_wrap</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
<p>Python would fork 4 times and start 4 concurrent runs of <code class="xref py py-func docutils literal notranslate"><span class="pre">rastrigin_wrap()</span></code>. All 4 runs
would write the file ‘params.txt’, overwriting each other. <code class="docutils literal notranslate"><span class="pre">partialwrap</span></code> provides hence the key
<cite>‘pid’:True</cite> to <code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code>, which then passes a unique process identifier
(<cite>pid</cite>) as a keyword to the <cite>parameterwriter</cite>, adds the <cite>pid</cite> to the function call, and then
also passes the <cite>pid</cite> as a keyword to <cite>outputreader</cite>. <code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code> normally
deletes <cite>parameterfile</cite> and <cite>outputfile</cite> at its end. In case of <cite>‘pid’:True</cite>, it deletes
<cite>parameterfile</cite> and <cite>outputfile</cite> suffixed with <cite>.pid</cite>, if present.</p>
<p>So all <cite>parameterwriter</cite> provided by <code class="docutils literal notranslate"><span class="pre">partialwrap</span></code> take a keyword <cite>pid</cite> and, if present, write
<cite>parameterfile.pid</cite> rather than simply <cite>parameterfile</cite>. Likewise all <cite>outputreader</cite> provided by
<code class="docutils literal notranslate"><span class="pre">partialwrap</span></code> take a keyword <cite>pid</cite> and if present read <cite>outputfile.pid</cite> rather than <cite>outputfile</cite>.
<code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code> then launches <cite>exe+[str(pid)]</cite> (or <cite>exe+’ ‘+str(pid) in case of
`’shell’:True</cite>). The external executable has hence to be able to read the <cite>pid</cite> from the command line
and, if present, read <cite>parameterfile.pid</cite> instead of <cite>parameterfile</cite> and write <cite>outputfile.pid</cite>
instead of <cite>outputfile</cite>. This can be handled with shell scripts if you are unable to change the
external model code (see below).</p>
<p>First, let’s change <cite>rastrigin1.py</cite> so that it checks for command line input and uses it for the
<cite>parameterfile</cite> and <cite>outputfile</cite>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File: rastrigin3.py</span>

<span class="c1"># get pid</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Rastrigin function a=10, b=2*pi</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">def</span> <span class="nf">rastrigin1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">10.</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">10.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>

<span class="c1"># read parameters</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">standard_parameter_reader</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">standard_parameter_reader</span><span class="p">(</span><span class="s1">&#39;params.txt&#39;</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="n">pid</span><span class="p">)</span>

<span class="c1"># calc function</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">rastrigin1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># write output file</span>
<span class="k">if</span> <span class="n">pid</span><span class="p">:</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">ff</span><span class="p">)</span>
</pre></div>
</div>
<p>Using <cite>rastrigin3.py</cite> with the key <cite>‘pid’:True</cite> would now evaluate four times the Rastrigin
function in parallel, every function evaluation using its individual parameter file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">standard_parameter_writer</span><span class="p">,</span> <span class="n">standard_output_reader</span>

<span class="n">rastrigin_exe</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span> <span class="s1">&#39;rastrigin3.py&#39;</span><span class="p">]</span>
<span class="n">parameterfile</span>  <span class="o">=</span> <span class="s1">&#39;params.txt&#39;</span>
<span class="n">outputfile</span>     <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span>
<span class="n">rastrigin_wrap</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">rastrigin_exe</span><span class="p">,</span>
                         <span class="n">parameterfile</span><span class="p">,</span> <span class="n">standard_parameter_writer</span><span class="p">,</span>
                         <span class="n">outputfile</span><span class="p">,</span> <span class="n">standard_output_reader</span><span class="p">,</span>
                         <span class="p">{</span><span class="s1">&#39;pid&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">})</span>

<span class="n">ndim</span>  <span class="o">=</span> <span class="mi">2</span>
<span class="n">xmin</span>  <span class="o">=</span> <span class="o">-</span><span class="mf">5.12</span>
<span class="n">xmax</span>  <span class="o">=</span>  <span class="mf">5.12</span>
<span class="n">neval</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">xmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random_sample</span><span class="p">((</span><span class="n">neval</span><span class="p">,</span><span class="n">ndim</span><span class="p">))</span>
<span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">rastrigin_wrap</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
<p>One can take advantage of the workers keyword in <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.differential_evolution.html#scipy.optimize.differential_evolution" title="(in SciPy v1.11.2)"><code class="xref py py-func docutils literal notranslate"><span class="pre">scipy.optimize.differential_evolution()</span></code></a> to
use available CPUs to find the minimum of the Rastrigin function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">standard_parameter_writer</span><span class="p">,</span> <span class="n">standard_output_reader</span>

<span class="n">rastrigin_exe</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span> <span class="s1">&#39;rastrigin3.py&#39;</span><span class="p">]</span>
<span class="n">parameterfile</span>  <span class="o">=</span> <span class="s1">&#39;params.txt&#39;</span>
<span class="n">outputfile</span>     <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span>
<span class="n">rastrigin_wrap</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">rastrigin_exe</span><span class="p">,</span>
                         <span class="n">parameterfile</span><span class="p">,</span> <span class="n">standard_parameter_writer</span><span class="p">,</span>
                         <span class="n">outputfile</span><span class="p">,</span> <span class="n">standard_output_reader</span><span class="p">,</span>
                         <span class="p">{</span><span class="s1">&#39;pid&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">})</span>

<span class="n">ndim</span>  <span class="o">=</span> <span class="mi">2</span>
<span class="n">xmin</span>  <span class="o">=</span> <span class="o">-</span><span class="mf">5.12</span>
<span class="n">xmax</span>  <span class="o">=</span>  <span class="mf">5.12</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">differential_evolution</span><span class="p">(</span><span class="n">rastrigin_wrap</span><span class="p">,</span> <span class="p">[(</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">),]</span><span class="o">*</span><span class="n">ndim</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<p>Or one could use the popular <code class="xref py py-mod docutils literal notranslate"><span class="pre">emcee</span></code> library to calculate parameter uncertainties with the
Markov chain Monte Carlo (MCMC) method. We take the example from the section on parallelization of
the <code class="xref py py-mod docutils literal notranslate"><span class="pre">emcee</span></code> documentation (<a class="reference external" href="https://emcee.readthedocs.io/en/stable/tutorials/parallel/">https://emcee.readthedocs.io/en/stable/tutorials/parallel/</a>) but
code the log-likelihood function as an external Python program:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File: logli1.py</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># get pid</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># log-likelihood</span>
<span class="k">def</span> <span class="nf">log_prob</span><span class="p">(</span><span class="n">theta</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">theta</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># read parameters</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">standard_parameter_reader</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">standard_parameter_reader</span><span class="p">(</span><span class="s1">&#39;params.txt&#39;</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="n">pid</span><span class="p">)</span>

<span class="c1"># calc function</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">log_prob</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># write output file</span>
<span class="k">if</span> <span class="n">pid</span><span class="p">:</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">ff</span><span class="p">)</span>
</pre></div>
</div>
<p>Partialize it and sample the log-likelihood with <code class="xref py py-mod docutils literal notranslate"><span class="pre">emcee</span></code> using a single processor:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">standard_parameter_writer</span><span class="p">,</span> <span class="n">standard_output_reader</span>

<span class="n">logli_exe</span>     <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span> <span class="s1">&#39;logli1.py&#39;</span><span class="p">]</span>
<span class="n">parameterfile</span> <span class="o">=</span> <span class="s1">&#39;params.txt&#39;</span>
<span class="n">outputfile</span>    <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span>
<span class="n">logli_wrap</span>    <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">logli_exe</span><span class="p">,</span>
                        <span class="n">parameterfile</span><span class="p">,</span> <span class="n">standard_parameter_writer</span><span class="p">,</span>
                        <span class="n">outputfile</span><span class="p">,</span> <span class="n">standard_output_reader</span><span class="p">,</span>
                        <span class="p">{</span><span class="s1">&#39;pid&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">})</span>

<span class="c1"># MCMC</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">emcee</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">initial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">nwalkers</span><span class="p">,</span> <span class="n">ndim</span> <span class="o">=</span> <span class="n">initial</span><span class="o">.</span><span class="n">shape</span>
<span class="n">nsteps</span>  <span class="o">=</span> <span class="mi">8</span>

<span class="n">sampler</span> <span class="o">=</span> <span class="n">emcee</span><span class="o">.</span><span class="n">EnsembleSampler</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">logli_wrap</span><span class="p">)</span>
<span class="n">start</span>   <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">sampler</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">end</span>     <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">serial_time</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Serial took </span><span class="si">{0:.1f}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">serial_time</span><span class="p">))</span>
</pre></div>
</div>
<p>This takes about 80 seconds on my machine. The parallel version using Python’s
<a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html#module-multiprocessing" title="(in Python v3.11)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">multiprocessing</span></code></a> module is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OMP_NUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>

<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="k">with</span> <span class="n">Pool</span><span class="p">()</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
    <span class="n">sampler</span> <span class="o">=</span> <span class="n">emcee</span><span class="o">.</span><span class="n">EnsembleSampler</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">logli_wrap</span><span class="p">,</span> <span class="n">pool</span><span class="o">=</span><span class="n">pool</span><span class="p">)</span>
    <span class="n">start</span>   <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">sampler</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">end</span>     <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">multi_time</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Multiprocessing took </span><span class="si">{0:.1f}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">multi_time</span><span class="p">))</span>
</pre></div>
</div>
<p>This needs about 26 seconds on my machine; about 3 times faster.</p>
<p>One can see that the <cite>parameterwriter</cite> <code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_ja()</span></code> works well with the ‘pid’
key. The user prepares the <cite>parameterfile</cite> with the tags #JA0000#, #JA0001#, ….
<code class="xref py py-func docutils literal notranslate"><span class="pre">sub_params_ja()</span></code> then takes <cite>parameterfile</cite> and writes the file
<cite>parameterfile.pid</cite> with the tags replaced by parameter values. No file is overwritten and
<cite>parameterfile</cite> can be reused by the next iteration or from a parallel process.</p>
<section id="using-a-launch-script-for-the-external-program">
<h3>Using a launch script for the external program<a class="headerlink" href="#using-a-launch-script-for-the-external-program" title="Permalink to this heading">¶</a></h3>
<p>If one cannot change the external program to use a process identifier <cite>pid</cite> from the command line,
one can use a launch script that deals with <cite>pid</cite> by creating individual directories for each model
run and moving and renaming <cite>parameterfile</cite> and <cite>outputfile</cite>. The program <cite>rastrigini1.py</cite>, which
has no <cite>pid</cite> ability, could still be used using a bash script on Unix/Linux systems:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># File: rastrigin1.sh</span>

<span class="c1">#!/bin/bash</span>

<span class="nb">set</span><span class="w"> </span>-e

<span class="c1"># get pid</span>
<span class="nv">pid</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span>

<span class="nv">exe</span><span class="o">=</span>rastrigin1.py
<span class="nv">pfile</span><span class="o">=</span>params.txt
<span class="nv">ofile</span><span class="o">=</span>out.txt

<span class="c1"># make individual run directory</span>
<span class="nv">rundir</span><span class="o">=</span>tmp.<span class="si">${</span><span class="nv">pid</span><span class="si">}</span>
mkdir<span class="w"> </span><span class="si">${</span><span class="nv">rundir</span><span class="si">}</span>

<span class="c1"># copy individual parameter file</span>
mv<span class="w"> </span><span class="si">${</span><span class="nv">pfile</span><span class="si">}</span>.<span class="si">${</span><span class="nv">pid</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">rundir</span><span class="si">}</span>/<span class="si">${</span><span class="nv">pfile</span><span class="si">}</span>

<span class="c1"># run in individual directory</span>
<span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">rundir</span><span class="si">}</span>
ln<span class="w"> </span>-s<span class="w"> </span>../<span class="si">${</span><span class="nv">exe</span><span class="si">}</span>
python3<span class="w"> </span><span class="si">${</span><span class="nv">exe</span><span class="si">}</span>

<span class="c1"># individualize output file</span>
mv<span class="w"> </span><span class="si">${</span><span class="nv">ofile</span><span class="si">}</span><span class="w"> </span>../<span class="si">${</span><span class="nv">ofile</span><span class="si">}</span>.<span class="si">${</span><span class="nv">pid</span><span class="si">}</span>

<span class="c1"># clean up</span>
<span class="nb">cd</span><span class="w"> </span>..
rm<span class="w"> </span>-r<span class="w"> </span><span class="si">${</span><span class="nv">rundir</span><span class="si">}</span>
</pre></div>
</div>
<p>This would be used with <code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code> like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">standard_parameter_writer</span><span class="p">,</span> <span class="n">standard_output_reader</span>

<span class="n">rastrigin_exe</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;./rastrigin1.sh&#39;</span><span class="p">]</span>
<span class="n">parameterfile</span>  <span class="o">=</span> <span class="s1">&#39;params.txt&#39;</span>
<span class="n">outputfile</span>     <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span>
<span class="n">rastrigin_wrap</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">rastrigin_exe</span><span class="p">,</span>
                         <span class="n">parameterfile</span><span class="p">,</span> <span class="n">standard_parameter_writer</span><span class="p">,</span>
                         <span class="n">outputfile</span><span class="p">,</span> <span class="n">standard_output_reader</span><span class="p">,</span>
                         <span class="p">{</span><span class="s1">&#39;pid&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">})</span>

<span class="n">x0</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">rastrigin_wrap</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;BFGS&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The bash script could, of course, also be a Python script to work on Windows platforms:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File: run_rastrigin1.py</span>

<span class="c1"># get pid</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;This scripts needs a process identifier (pid) as command line argument.&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="n">exe</span>   <span class="o">=</span> <span class="s1">&#39;rastrigin1.py&#39;</span>
<span class="n">pfile</span> <span class="o">=</span> <span class="s1">&#39;params.txt&#39;</span>
<span class="n">ofile</span> <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span>

<span class="c1"># make individual run directory</span>
<span class="n">rundir</span> <span class="o">=</span> <span class="s1">&#39;tmp.&#39;</span><span class="o">+</span><span class="n">pid</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">rundir</span><span class="p">)</span>

<span class="c1"># copy individual parameter file</span>
<span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">pfile</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">pid</span><span class="p">,</span> <span class="n">rundir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">pfile</span><span class="p">)</span>

<span class="c1"># run in individual directory</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">exe</span><span class="p">,</span> <span class="n">rundir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">exe</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">rundir</span><span class="p">)</span>
<span class="n">err</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span> <span class="n">exe</span><span class="p">],</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>

<span class="c1"># make output available to exe_wrapper</span>
<span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">ofile</span><span class="p">,</span> <span class="s1">&#39;../&#39;</span><span class="o">+</span><span class="n">ofile</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">pid</span><span class="p">)</span>

<span class="c1"># clean up</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">rundir</span><span class="p">)</span>
</pre></div>
</div>
<p>This would be used with <code class="xref py py-func docutils literal notranslate"><span class="pre">exe_wrapper()</span></code> like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">partialwrap</span> <span class="kn">import</span> <span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">standard_parameter_writer</span><span class="p">,</span> <span class="n">standard_output_reader</span>

<span class="n">rastrigin_exe</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span> <span class="s1">&#39;run_rastrigin1.py&#39;</span><span class="p">]</span>
<span class="n">parameterfile</span>  <span class="o">=</span> <span class="s1">&#39;params.txt&#39;</span>
<span class="n">outputfile</span>     <span class="o">=</span> <span class="s1">&#39;out.txt&#39;</span>
<span class="n">rastrigin_wrap</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">exe_wrapper</span><span class="p">,</span> <span class="n">rastrigin_exe</span><span class="p">,</span>
                         <span class="n">parameterfile</span><span class="p">,</span> <span class="n">standard_parameter_writer</span><span class="p">,</span>
                         <span class="n">outputfile</span><span class="p">,</span> <span class="n">standard_output_reader</span><span class="p">,</span>
                         <span class="p">{</span><span class="s1">&#39;pid&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">})</span>

<span class="n">x0</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">rastrigin_wrap</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;BFGS&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>That’s all Folks!</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="contents.html">partialwrap</a></h1>



<p class="blurb">Wrappers of external executables and Python functions for functools.partial.</p>






<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#quick-usage-guide">Quick usage guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#requirements">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#license">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#indices-and-tables">Indices and tables</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">User Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#simple-python-functions">Simple Python functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#masked-parameters-in-python-functions">Masked parameters in Python functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#external-executables">External executables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#masked-parameters-with-external-executables">Masked parameters with external executables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#additional-arguments-for-exe-wrapper">Additional arguments for exe_wrapper</a></li>
<li class="toctree-l2"><a class="reference internal" href="#provided-parameterwriter-and-outputreader">Provided parameterwriter and outputreader</a></li>
<li class="toctree-l2"><a class="reference internal" href="#parallel-evaluation-of-external-executables">Parallel evaluation of external executables</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#using-a-launch-script-for-the-external-program">Using a launch script for the external program</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">Public API</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">Authors</a></li>
</ul>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="https://github.com/mcuntz/partialwrap">partialwrap @ GitHub</a></li>
    
    <li class="toctree-l1"><a href="https://doi.org/10.5281/zenodo.3893705">partialwrap @ Zenodo</a></li>
    
    <li class="toctree-l1"><a href="https://pypi.org/project/partialwrap">partialwrap @ PyPI</a></li>
    
    <li class="toctree-l1"><a href="https://anaconda.org/conda-forge/partialwrap">partialwrap @ conda-forge</a></li>
    
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="contents.html">Documentation overview</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">Quickstart</a></li>
      <li>Next: <a href="api.html" title="next chapter">Public API</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016-2023, Matthias Cuntz.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="_sources/userguide.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>